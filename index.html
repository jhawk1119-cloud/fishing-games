<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Clicker Fishing Game - Full Version</title>
    <style>
        /* [Your CSS STYLES ARE ALL HERE AND CORRECT] */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            align-items: flex-start; /* Align containers to the top */
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f8ff;
            margin: 0;
            color: #333;
            padding-top: 30px; /* Add some top padding */
        }

        #game-container {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 550px;
            margin-bottom: 20px;
        }

        #fishing-button {
            padding: 15px 30px;
            font-size: 20px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.1s;
        }

        #fishing-button:hover {
            background-color: #45a049;
        }

        #fishing-button:active {
            transform: scale(0.98);
        }

        #result {
            margin-top: 20px;
            font-size: 18px;
            min-height: 50px;
        }

        #inventory, #money-display, #current-rod, #fish-index, #level-display, #achievements-list-container {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            text-align: left;
            background: #fafafa;
        }
        
        /* LEVEL DISPLAY */
        #level-display {
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            background-color: #ffe0b2;
            padding: 15px 10px;
        }

        #progress-container {
            width: 100%;
            height: 15px;
            background-color: #ddd;
            border-radius: 7px;
            margin-top: 5px;
            overflow: hidden;
        }

        #level-progress-bar {
            height: 100%;
            width: 0%;
            background-color: #ff9800;
            transition: width 0.3s ease-out;
        }

        #progress-text {
            font-size: 0.8em;
            margin-top: 3px;
            color: #555;
        }


        #money-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #2196F3;
            text-align: center;
        }

        #current-rod {
            font-size: 0.9em;
            text-align: center;
            background-color: #e0f7fa;
        }

        /* Rarity Classes (Used for color spans) */
        .rarity-common { color: #555; }
        .rarity-uncommon { color: #008000; }
        .rarity-rare { color: #0000ff; }
        .rarity-epic { color: #a020f0; } 
        .rarity-legendary { color: #800080; }
        .rarity-mythic { color: #ff8c00; }
        .rarity-exotic { color: #ffd700; } 
        .rarity-secret { color: #ff69b4; }
        .rarity-depthful { color: #005f73; font-weight: bold; }
        .rarity-ethereal { color: #9d4edd; font-weight: bold; }
        .rarity-cosmic { color: #ff006e; font-weight: bold; }
        .rarity-void { color: #1e1e1e; background-color: #aaa; color: #fff; } 
        .rarity-temporal { color: #ff4500; font-weight: bold; } 
        .rarity-chromatic { color: #ff00ff; font-weight: bold; } 
        .rarity-primal { color: #a0522d; font-weight: bold; } 
        .rarity-celestial { color: #4682b4; font-weight: bold; } 
        .rarity-divine { color: #daa520; font-weight: bold; } 
        .rarity-legendary-x { color: #ff0000; font-weight: bold; } 
        .rarity-ultimate { color: #00ffff; font-weight: bold; } 
        .rarity-astral { color: #7fff00; font-weight: bold; } 
        .rarity-cosmic-horror { color: #6f2dbf; font-weight: bold; } 
        .rarity-omega { color: #f0f8ff; background-color: #000; font-weight: bold; } 
        .rarity-apex { color: #dc143c; }
        .rarity-dimensional { color: #00bfff; font-weight: bold; } 
        .rarity-reality { color: #ffc0cb; font-weight: bold; background-color: #800000; }
        .rarity-singularity { color: #000; background-color: #fff; font-weight: bold; border: 2px solid #000; }
        .rarity-existence { color: #fff; background-color: #000080; font-weight: bold; border: 2px solid #000; }
        .rarity-omnipresence { color: #ff00ff; font-weight: bold; background-color: #333; }
        .rarity-origin { color: #ff4500; font-weight: bold; border: 2px solid #ff4500; }
        .rarity-pinnacle { color: #00ffff; font-weight: bold; background-color: #800000; }
        .rarity-eternal { color: #ffd700; font-weight: bold; background-color: #000000; }
        
        /* NEW ULTRA TIER ROD STYLES */
        .rarity-hyperbolic { color: #00ff00; font-weight: bold; background-color: #4b0082; }
        .rarity-transcendent { color: #ff69b4; font-weight: bold; background-color: #191970; }
        .rarity-omnific { color: #ffffff; font-weight: bold; background-color: #8b0000; }
        
        /* --- NEW ULTRA-RARITIES --- */
        .rarity-absolute { color: #000000; background-color: #ffffff; border: 4px double #ff0000; font-weight: bolder; }
        .rarity-supremacy { color: #ffffff; background-color: #0000ff; border: 4px double #ffffff; font-weight: bolder; }
        .rarity-transcendence { color: #ff00ff; background-color: #000000; border: 4px double #ffff00; font-weight: bolder; }
        .rarity-primordial { color: #800000; background-color: #ffa500; border: 4px double #800000; font-weight: bolder; }
        .rarity-unbound { color: #ffffff; background-color: #ff00ff; border: 4px double #00ffff; font-weight: bolder; }
        .rarity-null { color: #ff0000; background-color: #000000; border: 4px double #ff0000; font-weight: bolder; }
        .rarity-true_form { color: #00ff00; background-color: #800080; border: 4px double #ffffff; font-weight: bolder; }
        .rarity-axiomatic { color: #00ffff; background-color: #008000; border: 4px double #ff0000; font-weight: bolder; }
        .rarity-final { color: #ffffff; background-color: #ff4500; border: 4px double #000000; font-weight: bolder; }
        .rarity-maximum { color: #000000; background-color: #ffffff; border: 5px solid #000000; font-weight: bolder; }


        /* --- Shop/Crafting Styles --- */
        #shop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #shop-box {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .shop-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #f7f7f7;
        }

        .rod-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .rod-item:last-child {
            border-bottom: none;
        }
        
        .rod-stats {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
        }
        
        .rod-stats span {
            margin-right: 15px;
        }

        .buy-button, .craft-button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: bold;
        }
        
        .buy-button {
            background-color: #007bff;
        }

        .craft-button {
            background-color: #ff9800;
        }

        .buy-button:disabled, .craft-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .equipped-label {
            background-color: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .recipe-materials {
            font-size: 0.85em;
            margin-top: 8px;
            line-height: 1.5;
        }

        /* --- Mini-Game Overlay Styles --- */
        #minigame-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #minigame-box {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        /* Minigame Display - Restored Target Style */
        #progress-bar-container {
            width: 100%;
            height: 25px;
            background-color: #ddd;
            border-radius: 5px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
            border: 2px solid #333;
        }

        #target-area { 
            position: absolute;
            /* Left and width will be set dynamically in JS */
            height: 100%;
            background-color: #00cc00; /* Green target */
            z-index: 10;
        }


        #progress-bar {
            height: 100%;
            width: 0%;
            background-color: #2196F3; /* Blue progress bar */
            position: absolute;
            left: 0;
            z-index: 20;
            transition: width 0.1s linear; 
        }

        #minigame-button {
            padding: 12px 25px;
            font-size: 18px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        #minigame-feedback {
            margin-top: 15px;
            font-weight: bold;
            min-height: 20px;
        }

        /* Achievements Styles */
        .achievement-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #ddd;
            opacity: 0.5; /* Locked by default */
        }
        
        .achievement-item.completed {
            opacity: 1; 
            background: #e6ffe6;
            padding: 8px;
            border-radius: 4px;
        }

        .achievement-title {
            font-weight: bold;
            font-size: 0.9em;
        }

        .achievement-desc {
            font-size: 0.8em;
            color: #555;
        }

        .achievement-icon {
            margin-right: 10px;
            font-size: 1.5em;
        }

        .achievement-status {
            font-size: 0.7em;
            font-weight: bold;
            color: #888;
            min-width: 80px;
            text-align: right;
        }

    </style>
</head>
<body>

<div id="game-container">
    <h2>üåä Ultimate Clicker Fishing Game üêü</h2>
    
    <div id="level-display">
        Level <span id="current-level">1</span>
        <div id="progress-container">
            <div id="level-progress-bar"></div>
        </div>
        <div id="progress-text">0 / 50 Fish Caught</div>
    </div>

    <div id="money-display">üí∞ Money: $0</div>
    
    <div id="current-rod">
        üé£ Current Rod: <span id="rod-name">Basic Rod</span> (Luck: <span id="rod-luck">0</span>, Lure Speed: <span id="rod-speed">1.0x Reel Progress</span>)
    </div>

    <div id="button-group">
        <button id="fishing-button">Click to Fish!</button>
        <button id="shop-button">üõí Open Shop</button>
        <button id="save-button" style="background-color:#007bff;">üíæ Save Game</button>
    </div>

    <div id="result">Waiting for a bite...</div>

    <div id="inventory">
        <h3>Inventory</h3>
        <ul id="fish-list">
            </ul>
        <button id="sell-all-button">Sell All Fish</button>
    </div>

    <div id="fish-index">
        <h3>Fish Index (Discovered)</h3>
        <ul id="index-list">
            </ul>
    </div>

    <div id="achievements-list-container">
        <h3>üèÜ Achievements</h3>
        <div id="achievements-list">
            </div>
    </div>
</div>

<div id="shop-overlay">
    <div id="shop-box">

        <div class="shop-section">
            <h4>üí∞ Purchase Rods</h4>
            <p>Buy entry-level rods directly with money.</p>
            <div id="shop-items-list">
                </div>
        </div>

        <div class="shop-section">
            <h4>üõ†Ô∏è Crafting Station</h4>
            <p>Craft advanced rods using rare fish from your inventory.</p>
            <div id="crafting-recipes-list">
                </div>
        </div>

        <button class="buy-button" style="background-color: #6c757d; width: 100%;" onclick="closeShop()">Close Shop</button>
    </div>
</div>

<div id="minigame-overlay">
    <div id="minigame-box">
        <h3>Mini-Game: Reel it In!</h3>
        <p>Click the button repeatedly to reel in the fish.</p>
        
        <div id="progress-bar-container">
            <div id="target-area"></div> 
            <div id="progress-bar"></div>
        </div>

        <p id="minigame-feedback">Clicks Remaining: <span id="clicks-remaining">5</span></p>
        <button id="minigame-button">REEL!</button>
    </div>
</div>

<script>
    // --- Configuration ---
    const RARITIES = [
        // Rarity Order is defined here, from least rare to most rare
        { name: 'Common', chance: 70, colorClass: 'rarity-common', value: 10, icon: 'üêü' },
        { name: 'Uncommon', chance: 15, colorClass: 'rarity-uncommon', value: 30, icon: 'üê†' },
        { name: 'Rare', chance: 8, colorClass: 'rarity-rare', value: 80, icon: 'üê°' },
        { name: 'Epic', chance: 3, colorClass: 'rarity-epic', value: 250, icon: 'ü¶ê' }, 
        { name: 'Legendary', chance: 2, colorClass: 'rarity-legendary', value: 750, icon: 'ü¶à' },
        { name: 'Mythic', chance: 1, colorClass: 'rarity-mythic', value: 2000, icon: 'üêâ' },
        { name: 'Exotic', chance: 0.5, colorClass: 'rarity-exotic', value: 6000, icon: 'ü¶ë' }, 
        { name: 'Secret', chance: 0.25, colorClass: 'rarity-secret', value: 15000, icon: 'üëª' },
        { name: 'Depthful', chance: 0.2, colorClass: 'rarity-depthful', value: 50000, icon: 'üåë' },
        { name: 'Ethereal', chance: 0.1, colorClass: 'rarity-ethereal', value: 150000, icon: '‚ú®' },
        { name: 'Cosmic', chance: 0.05, colorClass: 'rarity-cosmic', value: 500000, icon: 'üå†' },
        { name: 'Void', chance: 0.025, colorClass: 'rarity-void', value: 1500000, icon: '‚ö´' },
        { name: 'Temporal', chance: 0.015, colorClass: 'rarity-temporal', value: 4000000, icon: '‚è≥' },
        { name: 'Chromatic', chance: 0.01, colorClass: 'rarity-chromatic', value: 10000000, icon: 'üåà' },
        { name: 'Primal', chance: 0.007, colorClass: 'rarity-primal', value: 25000000, icon: 'üåã' },
        { name: 'Celestial', chance: 0.005, colorClass: 'rarity-celestial', value: 60000000, icon: '‚òÄÔ∏è' },
        { name: 'Divine', chance: 0.003, colorClass: 'rarity-divine', value: 150000000, icon: 'üî±' },
        { name: 'Legendary X', chance: 0.002, colorClass: 'rarity-legendary-x', value: 400000000, icon: '‚ùó' },
        { name: 'Ultimate', chance: 0.001, colorClass: 'rarity-ultimate', value: 1000000000, icon: 'üëë' },
        { name: 'Astral', chance: 0.0005, colorClass: 'rarity-astral', value: 7000000000, icon: 'üåü' }, 
        { name: 'Cosmic Horror', chance: 0.00025, colorClass: 'rarity-cosmic-horror', value: 35000000000, icon: 'üëæ' }, 
        { name: 'Omega', chance: 0.0001, colorClass: 'rarity-omega', value: 200000000000, icon: 'üåå' }, 
        { name: 'Apex', chance: 0.00005, colorClass: 'rarity-apex', value: 1000000000000, icon: 'üî¥' }, 
        { name: 'Dimensional', chance: 0.00002, colorClass: 'rarity-dimensional', value: 150000000000000, icon: 'üåÄ' }, 
        { name: 'Reality', chance: 0.000005, colorClass: 'rarity-reality', value: 400000000000000, icon: '‚¨ú' },
        { name: 'Singularity', chance: 0.000001, colorClass: 'rarity-singularity', value: 1000000000000000, icon: '‚ö´' },

        { name: 'Existence', chance: 0.0000005, colorClass: 'rarity-existence', value: 5000000000000000, icon: 'üü¶' },
        { name: 'Omnipresence', chance: 0.0000002, colorClass: 'rarity-omnipresence', value: 25000000000000000, icon: 'üü™' },
        { name: 'Origin', chance: 0.00000008, colorClass: 'rarity-origin', value: 100000000000000000, icon: 'üü†' },
        { name: 'Pinnacle', chance: 0.00000002, colorClass: 'rarity-pinnacle', value: 500000000000000000, icon: 'üíé' },
        { name: 'Eternal', chance: 0.000000005, colorClass: 'rarity-eternal', value: 2000000000000000000, icon: '‚öúÔ∏è' },
        
        // --- NEW 10 ULTRA RARITIES (BETTER THAN ETERNAL) ---
        { name: 'Absolute', chance: 0.000000002, colorClass: 'rarity-absolute', value: 50000000000000000000, icon: 'üîÜ' }, // 50 Quintillion
        { name: 'Supremacy', chance: 0.000000001, colorClass: 'rarity-supremacy', value: 150000000000000000000, icon: 'üíØ' }, // 150 Quintillion
        { name: 'Transcendence', chance: 0.0000000005, colorClass: 'rarity-transcendence', value: 500000000000000000000, icon: '‚ôæÔ∏è' }, // 500 Quintillion
        { name: 'Primordial', chance: 0.0000000002, colorClass: 'rarity-primordial', value: 1500000000000000000000, icon: 'üåã' }, // 1.5 Sextillion
        { name: 'Unbound', chance: 0.0000000001, colorClass: 'rarity-unbound', value: 5000000000000000000000, icon: '‚ú®' }, // 5 Sextillion
        { name: 'Null', chance: 0.00000000005, colorClass: 'rarity-null', value: 15000000000000000000000, icon: '‚ö´' }, // 15 Sextillion
        { name: 'True Form', chance: 0.00000000002, colorClass: 'rarity-true_form', value: 50000000000000000000000, icon: 'üü¢' }, // 50 Sextillion
        { name: 'Axiomatic', chance: 0.00000000001, colorClass: 'rarity-axiomatic', value: 150000000000000000000000, icon: 'üìê' }, // 150 Sextillion
        { name: 'Final', chance: 0.000000000005, colorClass: 'rarity-final', value: 500000000000000000000000, icon: 'üü•' }, // 500 Sextillion
        { name: 'Maximum', chance: 0.000000000001, colorClass: 'rarity-maximum', value: 2000000000000000000000000, icon: '‚úÖ' }, // 2 Septillion
        // --- END NEW RARITIES ---
        
    ].sort((a, b) => b.chance - a.chance);

    const FISH_NAMES = {
        'Common': ['Minnow', 'Trout', 'Bass', 'Sardine', 'Anchovy', 'Cod', 'Flounder', 'Prawn'],
        'Uncommon': ['Perch', 'Carp', 'Catfish', 'Haddock', 'Snapper', 'Mackerel', 'Bluegill', 'Goby'],
        'Rare': ['Salmon', 'Eel', 'Pike', 'Halibut', 'Tuna', 'Dolphin Fish', 'Redfish', 'Sea Bass'],
        'Epic': ['Mahi-Mahi', 'Kingfish', 'Barracuda', 'Grouper', 'Wahoo', 'Albacore', 'Amberjack'], 
        'Legendary': ['Blue Marlin', 'Swordfish', 'Giant Squid', 'Opah', 'Viperfish', 'Arapaima'],
        'Mythic': ['Kraken Trout', 'Sunken Shark', 'Nessie Bass', 'Siren Salmon', 'Phantom Eel', 'Giga Ray'],
        'Exotic': ['Abyssal Dragonfish', 'Void Ray', 'Crystal Cod', 'Lava Bass', 'Electric Flounder', 'Shadow Salmon'],
        'Secret': ['Cosmic Jellyfish', 'Ethereal Blob', 'Time Trout', 'Ghost Mackerel', 'Dream Tilapia'],
        'Depthful': [
            'Shadow Fin', 'Glow Whale', 'Deep Sea Angler', 'Chasm Shark', 'Crag Cod', 'Onyx Bass', 
            'Trench Eel', 'Midnight Flounder', 'Pressure Carp'
        ],
        'Ethereal': [
            'Whisper Eel', 'Astral Shrimp', 'Phantom Flounder', 'Mist Marlin', 'Aurora Trout', 'Spirit Carp',
            'Specter Salmon', 'Vapor Whale'
        ],
        'Cosmic': [
            'Stardust Ray', 'Nebula Tetra', 'Galactic Grouper', 'Comet Carp', 'Black Hole Bass', 'Quasar Fish',
            'Void Starfish', 'Wormhole Wrasse'
        ],
        'Void': [
            'Empty Fin', 'Null Clam', 'Zero Cod', 'Entropy Eel',
            'Non-Existent Tuna', 'Oblivion Prawn'
        ],
        'Temporal': [
            'Clockwork Trout', 'Epoch Bass', 'Momentary Pike', 'Chrono Flounder',
            'Relic Salmon', 'Past Perch'
        ],
        'Chromatic': [
            'Rainbow Minnow', 'Prism Shark', 'Spectrum Bass', 'Iridescent Wrasse',
            'Holo Ray', 'Lightwave Ling'
        ],
        'Primal': [
            'Dinosaur Sturgeon', 'Tar Pit Perch', 'Ancient Carp', 'Fossil Fin',
            'Stone Scale', 'Magmafin'
        ],
        'Celestial': [
            'Sunfish', 'Moon Trout', 'Planet Prawn', 'Starfish',
            'Zodiac Carp', 'Orion Grouper'
        ],
        'Divine': [
            'Godly Bass', 'Angel Fin', 'Holy Mackerel', 'Seraphim Salmon',
            'Halo Haddock', 'Olympus Eel'
        ],
        'Legendary X': [
            'The One That Got Away', 'Infinite Eel', 'Ultimate Squid',
            'The Uncatchable', 'Fate Fin'
        ],
        'Ultimate': [
            'The Creator Cod', 'Omni-Bass', 'Final Fin', 
            'Alpha Sturgeon', 'Grand Kraken'
        ],
        'Astral': [ 
            'Idea Fish', 'Concept Carp', 'Dream Leviathan', 
            'Thought Trout', 'Pure Entity', 'Starlight Trout', 'Cosmic Flounder'
        ],
        'Cosmic Horror': [ 
            'The World Eater', 'The Fin of Fate', 'The Destroyer', 
            'World Serpent', 'Titan Shark', 'Existential Cod'
        ],
        'Omega': [ 
            'Primordial Leviathan', 'Oceanius Rex', 'Absolute Zero Fin', 
            'God Hand Ray', 'Void Essence Bass' 
        ],
        'Apex': [ 
            'Omega Trout', 'Apex Predator Shark', 'Final Boss Cod', 
            'Infinity Fish', 'Dimensional Carp' 
        ],
        'Dimensional': [ 
            'Hyperspace Tuna', 'Quantum Shark', 'Paradox Pike',
            'Multiverse Ray', 'Mirror Fish'
        ],
        'Reality': [ 
            'The Editor', 'The Source Cod', 'Pattern Shark',
            'Law of Physics Fish', 'True Form Eel'
        ],
        'Singularity': [ 
            'The Unseen', 'Final Entity', 'Perfect Fish',
            'Absolute Zero', 'Origin'
        ],
        'Existence': [ 
            'Omnipotent Trout', 'Axiom Prawn', 'Logic Eel',
            'The Definition', 'First Cause Carp'
        ],
        'Omnipresence': [ 
            'Everywhere Fin', 'Timeless Tuna', 'Ubiquitous Shark',
            'The Observer', 'Fourth Dimension Ray'
        ],
        'Origin': [ 
            'Big Bang Bass', 'Seed Salmon', 'Protogenesis Pike',
            'First Light Flounder', 'The Beginning'
        ],
        'Pinnacle': [ 
            'Zenith Eel', 'The Apex Point', 'Acme Angler',
            'Summit Sturgeon', 'Ultimate Zenith'
        ],
        'Eternal': [ 
            'Infinite Carp', 'Forever Fin', 'Aion Bass',
            'Eternity Eel', 'The Unending'
        ],
        // --- NEW FISH NAMES ---
        'Absolute': ['Absolute Unit', 'The Whole Thing', 'Limitless Trout'],
        'Supremacy': ['Alpha Predator', 'The Ultimate Fin', 'Apex Entity'],
        'Transcendence': ['God Fin', 'Ethereal King', 'The Final Catch'],
        'Primordial': ['Ancient Source', 'First Wave Fish', 'Unborn Bass'],
        'Unbound': ['Free Fin', 'Unrestricted Ray', 'Pure Energy Cod'],
        'Null': ['Zero Point Tuna', 'Anti-Existence Fish', 'Entropy Fin'],
        'True Form': ['Perfect Bass', 'Core Salmon', 'True Entity'],
        'Axiomatic': ['Self-Evident Eel', 'Irrefutable Ray', 'Theorem Trout'],
        'Final': ['Final Boss Ray', 'End of Time Fish', 'Apocalypse Cod'],
        'Maximum': ['The Absolute Limit', 'Maxxed Fin', 'Finality Pike'],
        // --- END NEW FISH NAMES ---

    };
    
    // Rods 
    const FISHING_RODS = [
        // --- Purchase Rods (Base 18 + 3 Old Ultra Tier + 3 New Ultra Tier + 3 NEWEST Purchase Rods = 27 total) ---
        { id: 'basic', name: 'Basic Rod', cost: 0, luck: 0, lureSpeedMultiplier: 1.0 },
        { id: 'wood', name: 'Wooden Rod', cost: 100, luck: 5, lureSpeedMultiplier: 1.2 },
        { id: 'fiberglass', name: 'Fiberglass Rod', cost: 500, luck: 15, lureSpeedMultiplier: 1.5 },
        { id: 'graphite', name: 'Graphite Rod', cost: 2500, luck: 40, lureSpeedMultiplier: 2.0 },
        { id: 'steel', name: 'Steel Rod', cost: 10000, luck: 80, lureSpeedMultiplier: 2.5 },
        
        { id: 'hardened_steel', name: 'Hardened Steel Rod', cost: 30000, luck: 150, lureSpeedMultiplier: 3.0 },

        { id: 'titanium', name: 'Titanium Rod', cost: 100000, luck: 300, lureSpeedMultiplier: 3.5 },
        
        { id: 'grade_5_titanium', name: 'Grade 5 Titanium Rod', cost: 350000, luck: 700, lureSpeedMultiplier: 4.0 },

        { id: 'carbon', name: 'Carbon Fiber Rod', cost: 1000000, luck: 1500, lureSpeedMultiplier: 5.0 },
        
        { id: 'layered_carbon', name: 'Layered Carbon Rod', cost: 5000000, luck: 3500, lureSpeedMultiplier: 6.0 },

        { id: 'maglev', name: 'Maglev Line Rod', cost: 20000000, luck: 8000, lureSpeedMultiplier: 7.5 },
        
        { id: 'quantum_line', name: 'Quantum Line Rod', cost: 75000000, luck: 20000, lureSpeedMultiplier: 9.0 },
        
        { id: 'diamond', name: 'Diamond Tipped Rod', cost: 250000000, luck: 50000, lureSpeedMultiplier: 11.0 },

        { id: 'reinforced_diamond', name: 'Reinforced Diamond Rod', cost: 1500000000, luck: 120000, lureSpeedMultiplier: 13.0 },

        { id: 'plasma', name: 'Plasma Energy Rod', cost: 8000000000, luck: 250000, lureSpeedMultiplier: 15.0 },

        { id: 'fusion_core', name: 'Fusion Core Rod', cost: 40000000000, luck: 500000, lureSpeedMultiplier: 18.0 },

        { id: 'singularity_rod', name: 'Singularity Rod', cost: 150000000000, luck: 1200000, lureSpeedMultiplier: 25.0 },
        
        { id: 'creator', name: 'Creator‚Äôs Quill Rod', cost: 500000000000, luck: 1500000, lureSpeedMultiplier: 30.0 },

        { id: 'god_hand', name: 'God Hand Rod', cost: 5000000000000, luck: 5000000, lureSpeedMultiplier: 50.0 },

        // --- PREVIOUSLY NEW RODS ---
        { id: 'transcendent_lure', name: 'Transcendent Lure Rod', cost: 15000000000000, luck: 8000000, lureSpeedMultiplier: 65.0 },
        { id: 'omni_hook', name: 'Omni Hook Rod', cost: 40000000000000, luck: 12000000, lureSpeedMultiplier: 80.0 },
        { id: 'limitless_line', name: 'Limitless Line Rod', cost: 100000000000000, luck: 20000000, lureSpeedMultiplier: 100.0 },
        // --- END PREVIOUSLY NEW RODS ---
        
        // --- NEW PURCHASE RODS ADDED HERE (Better than Limitless Line Rod) ---
        { id: 'cosmic_net', name: 'Cosmic Net Rod', cost: 500000000000000, luck: 50000000, lureSpeedMultiplier: 200.0 },
        { id: 'infinite_pull', name: 'Infinite Pull Rod', cost: 2500000000000000, luck: 150000000, lureSpeedMultiplier: 500.0 },
        { id: 'true_creation', name: 'True Creation Rod', cost: 10000000000000000, luck: 400000000, lureSpeedMultiplier: 1000.0 },
        // --- END NEWEST PURCHASE RODS ---

        // --- OLD ULTRA TIER RODS (Now slightly cheaper, and pushed down the list) ---
        { id: 'hyperbolic_net', name: 'Hyperbolic Net Rod', cost: 30000000000000000, luck: 600000000, lureSpeedMultiplier: 2000.0 },
        { id: 'dimensional_hook', name: 'Dimensional Hook Rod', cost: 120000000000000000, luck: 1200000000, lureSpeedMultiplier: 4000.0 },
        { id: 'reality_warper', name: 'Reality Warper Rod', cost: 500000000000000000, luck: 2500000000, lureSpeedMultiplier: 8000.0 },
        
        
        // --- Craftable Rods (GREATLY DECREASED recipe costs) ---

        { id: 'ethereal_net', name: 'Ethereal Net Rod', luck: 500, lureSpeedMultiplier: 5.0, 
            recipe: [
                { rarity: 'Legendary', name: 'Blue Marlin', required: 1 }, 
                { rarity: 'Mythic', name: 'Kraken Trout', required: 1 }
            ]
        },
        
        { id: 'celestial', name: 'Celestial Rod', luck: 1000, lureSpeedMultiplier: 10.0, 
            recipe: [
                { rarity: 'Mythic', name: 'Kraken Trout', required: 2 }, 
                { rarity: 'Exotic', name: 'Crystal Cod', required: 1 }
            ]
        },

        { id: 'cosmic_alignment', name: 'Cosmic Alignment Rod', luck: 2500, lureSpeedMultiplier: 15.0, 
            recipe: [
                { rarity: 'Exotic', name: 'Abyssal Dragonfish', required: 2 }, 
                { rarity: 'Secret', name: 'Cosmic Jellyfish', required: 1 } 
            ]
        },

        { id: 'void_siphon', name: 'Void Siphon Rod', luck: 6000, lureSpeedMultiplier: 20.0, 
            recipe: [
                { rarity: 'Secret', name: 'Ethereal Blob', required: 3 }, 
                { rarity: 'Depthful', name: 'Glow Whale', required: 1 } 
            ]
        },

        { id: 'abyss_weaver', name: 'Abyss Weaver Rod', luck: 15000, lureSpeedMultiplier: 30.0, 
            recipe: [
                { rarity: 'Depthful', name: 'Shadow Fin', required: 4 }, 
                { rarity: 'Ethereal', name: 'Whisper Eel', required: 2 } 
            ]
        },

        { id: 'temporal_thread', name: 'Temporal Thread Rod', luck: 35000, lureSpeedMultiplier: 45.0, 
            recipe: [
                { rarity: 'Ethereal', name: 'Astral Shrimp', required: 5 }, 
                { rarity: 'Cosmic', name: 'Black Hole Bass', required: 2 } 
            ]
        },

        { id: 'primal_anchor', name: 'Primal Anchor Rod', luck: 75000, lureSpeedMultiplier: 60.0, 
            recipe: [
                { rarity: 'Cosmic', name: 'Nebula Tetra', required: 6 }, 
                { rarity: 'Void', name: 'Entropy Eel', required: 3 } 
            ]
        },

        { id: 'chromatic_flux', name: 'Chromatic Flux Rod', luck: 150000, lureSpeedMultiplier: 90.0, 
            recipe: [
                { rarity: 'Void', name: 'Null Clam', required: 8 }, 
                { rarity: 'Temporal', name: 'Clockwork Trout', required: 4 } 
            ]
        },

        { id: 'divine_core', name: 'Divine Core Rod', luck: 300000, lureSpeedMultiplier: 120.0, 
            recipe: [
                { rarity: 'Temporal', name: 'Epoch Bass', required: 10 }, 
                { rarity: 'Chromatic', name: 'Prism Shark', required: 5 } 
            ]
        },

        { id: 'primal_scepter', name: 'Primal Scepter Rod', luck: 600000, lureSpeedMultiplier: 180.0, 
            recipe: [
                { rarity: 'Chromatic', name: 'Rainbow Minnow', required: 12 }, 
                { rarity: 'Primal', name: 'Dinosaur Sturgeon', required: 6 } 
            ]
        },

        { id: 'legendary_x_conduit', name: 'Legendary X Conduit Rod', luck: 1200000, lureSpeedMultiplier: 250.0, 
            recipe: [
                { rarity: 'Primal', name: 'Magmafin', required: 15 }, 
                { rarity: 'Celestial', name: 'Sunfish', required: 7 } 
            ]
        },
        
        { id: 'ultimate_harness', name: 'Ultimate Harness Rod', luck: 2500000, lureSpeedMultiplier: 400.0, 
            recipe: [
                { rarity: 'Celestial', name: 'Starfish', required: 20 }, 
                { rarity: 'Divine', name: 'Godly Bass', required: 10 } 
            ]
        },

        // --- NEW CRAFTABLE RODS (Better than Ultimate Harness Rod) ---
        { id: 'cosmic_horror_hook', name: 'Cosmic Horror Hook Rod', luck: 5000000, lureSpeedMultiplier: 800.0,
            recipe: [
                { rarity: 'Divine', name: 'Seraphim Salmon', required: 25 },
                { rarity: 'Legendary X', name: 'The One That Got Away', required: 12 }
            ]
        },

        { id: 'omega_line', name: 'Omega Line Rod', luck: 10000000, lureSpeedMultiplier: 1500.0,
            recipe: [
                { rarity: 'Legendary X', name: 'The Uncatchable', required: 30 },
                { rarity: 'Ultimate', name: 'Grand Kraken', required: 15 }
            ]
        },

        { id: 'apex_net', name: 'Apex Net Rod', luck: 25000000, lureSpeedMultiplier: 3000.0,
            recipe: [
                { rarity: 'Ultimate', name: 'The Creator Cod', required: 35 },
                { rarity: 'Astral', name: 'Idea Fish', required: 20 }
            ]
        },

        { id: 'dimensional_weaver', name: 'Dimensional Weaver Rod', luck: 50000000, lureSpeedMultiplier: 6000.0,
            recipe: [
                { rarity: 'Astral', name: 'Pure Entity', required: 40 },
                { rarity: 'Cosmic Horror', name: 'The World Eater', required: 25 }
            ]
        },

        { id: 'reality_anchor', name: 'Reality Anchor Rod', luck: 100000000, lureSpeedMultiplier: 10000.0,
            recipe: [
                { rarity: 'Cosmic Horror', name: 'The Destroyer', required: 50 },
                { rarity: 'Omega', name: 'Oceanius Rex', required: 30 }
            ]
        },

        { id: 'singularity_harness', name: 'Singularity Harness Rod', luck: 250000000, lureSpeedMultiplier: 20000.0,
            recipe: [
                { rarity: 'Omega', name: 'God Hand Ray', required: 60 },
                { rarity: 'Apex', name: 'Infinity Fish', required: 35 }
            ]
        },
        
        { id: 'existence_scepter', name: 'Existence Scepter Rod', luck: 500000000, lureSpeedMultiplier: 40000.0,
            recipe: [
                { rarity: 'Apex', name: 'Omega Trout', required: 70 },
                { rarity: 'Dimensional', name: 'Quantum Shark', required: 40 }
            ]
        },

        { id: 'omnipresence_lure', name: 'Omnipresence Lure Rod', luck: 1000000000, lureSpeedMultiplier: 80000.0,
            recipe: [
                { rarity: 'Dimensional', name: 'Hyperspace Tuna', required: 80 },
                { rarity: 'Reality', name: 'The Editor', required: 50 }
            ]
        },

        { id: 'origin_thread', name: 'Origin Thread Rod', luck: 2500000000, lureSpeedMultiplier: 160000.0,
            recipe: [
                { rarity: 'Reality', name: 'The Source Cod', required: 100 },
                { rarity: 'Singularity', name: 'The Unseen', required: 60 }
            ]
        },
        
        { id: 'pinnacle_hook', name: 'Pinnacle Hook Rod', luck: 5000000000, lureSpeedMultiplier: 320000.0,
            recipe: [
                { rarity: 'Singularity', name: 'Perfect Fish', required: 120 },
                { rarity: 'Existence', name: 'The Definition', required: 70 }
            ]
        },
        
        { id: 'eternal_line', name: 'Eternal Line Rod', luck: 10000000000, lureSpeedMultiplier: 640000.0,
            recipe: [
                { rarity: 'Existence', name: 'First Cause Carp', required: 150 },
                { rarity: 'Omnipresence', name: 'Timeless Tuna', required: 80 }
            ]
        },
        
        // --- NEW ULTRA-TIER CRAFTABLE RODS (The absolute top) ---
        { id: 'absolute_scepter', name: 'Absolute Scepter Rod', luck: 25000000000, lureSpeedMultiplier: 1280000.0,
            recipe: [
                { rarity: 'Omnipresence', name: 'Everywhere Fin', required: 200 },
                { rarity: 'Origin', name: 'Big Bang Bass', required: 90 }
            ]
        },
        
        { id: 'supremacy_coil', name: 'Supremacy Coil Rod', luck: 50000000000, lureSpeedMultiplier: 2560000.0,
            recipe: [
                { rarity: 'Origin', name: 'The Beginning', required: 250 },
                { rarity: 'Pinnacle', name: 'Zenith Eel', required: 100 }
            ]
        },
        
        { id: 'transcendence_reel', name: 'Transcendence Reel Rod', luck: 100000000000, lureSpeedMultiplier: 5120000.0,
            recipe: [
                { rarity: 'Pinnacle', name: 'Ultimate Zenith', required: 300 },
                { rarity: 'Eternal', name: 'The Unending', required: 110 }
            ]
        },

        { id: 'primordial_bait', name: 'Primordial Bait Rod', luck: 200000000000, lureSpeedMultiplier: 10240000.0,
            recipe: [
                { rarity: 'Eternal', name: 'Infinite Carp', required: 400 },
                { rarity: 'Absolute', name: 'Absolute Unit', required: 120 }
            ]
        },

        { id: 'unbound_line', name: 'Unbound Line Rod', luck: 400000000000, lureSpeedSpeedMultiplier: 20480000.0,
            recipe: [
                { rarity: 'Absolute', name: 'The Whole Thing', required: 500 },
                { rarity: 'Supremacy', name: 'Alpha Predator', required: 130 }
            ]
        },

        { id: 'null_lure', name: 'Null Lure Rod', luck: 800000000000, lureSpeedMultiplier: 40960000.0,
            recipe: [
                { rarity: 'Supremacy', name: 'Apex Entity', required: 600 },
                { rarity: 'Transcendence', name: 'God Fin', required: 140 }
            ]
        },

        { id: 'true_form_rod', name: 'True Form Rod', luck: 1600000000000, lureSpeedMultiplier: 81920000.0,
            recipe: [
                { rarity: 'Transcendence', name: 'Ethereal King', required: 700 },
                { rarity: 'Primordial', name: 'Ancient Source', required: 150 }
            ]
        },

        { id: 'axiomatic_reel', name: 'Axiomatic Reel Rod', luck: 3200000000000, lureSpeedMultiplier: 163840000.0,
            recipe: [
                { rarity: 'Primordial', name: 'Unborn Bass', required: 800 },
                { rarity: 'Unbound', name: 'Unrestricted Ray', required: 160 }
            ]
        },

        { id: 'final_ultimate', name: 'Final Ultimate Rod', luck: 6400000000000, lureSpeedMultiplier: 327680000.0,
            recipe: [
                { rarity: 'Unbound', name: 'Pure Energy Cod', required: 900 },
                { rarity: 'Null', name: 'Zero Point Tuna', required: 170 }
            ]
        },

        { id: 'maximum_overdrive', name: 'Maximum Overdrive Rod', luck: 12800000000000, lureSpeedMultiplier: 655360000.0,
            recipe: [
                { rarity: 'Null', name: 'Anti-Existence Fish', required: 1000 },
                { rarity: 'True Form', name: 'Perfect Bass', required: 180 }
            ]
        },

        // --- END NEW CRAFTABLE RODS ---

    ];

    // --- Achievements Configuration ---
    const ACHIEVEMENTS = [
        // Fish Count
        { id: 'fish_10', title: 'Novice Angler', desc: 'Catch 10 fish.', goal: 10, type: 'catchCount', completed: false, icon: 'üî∞' },
        { id: 'fish_100', title: 'A Good Haul', desc: 'Catch 100 fish.', goal: 100, type: 'catchCount', completed: false, icon: 'üé£' },
        { id: 'fish_1000', title: 'Master Caster', desc: 'Catch 1,000 fish.', goal: 1000, type: 'catchCount', completed: false, icon: '‚≠ê' },
        { id: 'fish_10000', title: 'Ocean Harvester', desc: 'Catch 10,000 fish.', goal: 10000, type: 'catchCount', completed: false, icon: 'üåä' },
        // Money
        { id: 'money_1000', title: 'First Earnings', desc: 'Earn a total of $1,000.', goal: 1000, type: 'totalMoney', completed: false, icon: 'üíµ' },
        { id: 'money_1m', title: 'Millionaire', desc: 'Earn a total of $1,000,000.', goal: 1000000, type: 'totalMoney', completed: false, icon: 'üí∞' },
        { id: 'money_1b', title: 'Billionaire', desc: 'Earn a total of $1,000,000,000.', goal: 1000000000, type: 'totalMoney', completed: false, icon: 'üëë' },
        // Rarity
        { id: 'catch_legendary', title: 'A True Legend', desc: 'Catch a Legendary fish.', goal: 'Legendary', type: 'rarity', completed: false, icon: '‚ú®' },
        { id: 'catch_mythic', title: 'Mythical Beast', desc: 'Catch a Mythic fish.', goal: 'Mythic', type: 'rarity', completed: false, icon: 'üêâ' },
        { id: 'catch_ultimate', title: 'The Final Fish', desc: 'Catch an Ultimate fish.', goal: 'Ultimate', type: 'rarity', completed: false, icon: 'üèÜ' },
        // Rods
        { id: 'buy_graphite', title: 'Mid-Tier', desc: 'Own the Graphite Rod or better.', goal: 'graphite', type: 'rodOwned', completed: false, icon: '‚öôÔ∏è' },
        { id: 'craft_ethereal', title: 'First Craft', desc: 'Craft the Ethereal Net Rod.', goal: 'ethereal_net', type: 'rodOwned', completed: false, icon: 'üõ†Ô∏è' },
        { id: 'craft_singularity', title: 'Breaking Limits', desc: 'Craft the Singularity Harness Rod.', goal: 'singularity_harness', type: 'rodOwned', completed: false, icon: '‚ö´' },
        { id: 'catch_maximum', title: 'Maximum Effort', desc: 'Catch the Maximum rarity fish.', goal: 'Maximum', type: 'rarity', completed: false, icon: '‚úÖ' },
        { id: 'catch_absolute', title: 'The Ultimate Catch', desc: 'Catch the Absolute rarity fish.', goal: 'Absolute', type: 'rarity', completed: false, icon: 'üîÜ' },
    ];
    
    // Leveling Configuration (Fish Caught per Level)
    const BASE_EXP = 50; // Initial fish needed for Lvl 2
    const EXP_GROWTH = 1.1; // Multiplier for each subsequent level
    
    // --- Game State ---
    let gameState = {
        money: 0,
        inventory: {}, // { 'Fish Name': count }
        fishIndex: {}, // { 'Fish Name': true }
        totalFishCaught: 0,
        totalMoneyEarned: 0,
        currentLevel: 1,
        fishToNextLevel: BASE_EXP,
        progressToNextLevel: 0,
        equippedRodId: 'basic',
        ownedRods: ['basic'],
        achievements: ACHIEVEMENTS.map(a => ({ id: a.id, completed: a.completed })),
    };
    
    let isFishing = false;
    let minigameData = {};
    let isMinigameActive = false;
    
    // --- Helper Functions ---
    
    function findRod(id) {
        return FISHING_RODS.find(rod => rod.id === id);
    }

    function findRarity(rarityName) {
        return RARITIES.find(r => r.name === rarityName);
    }

    function formatNumber(num) {
        if (num >= 1e24) return (num / 1e24).toFixed(2) + ' Septillion';
        if (num >= 1e21) return (num / 1e21).toFixed(2) + ' Sextillion';
        if (num >= 1e18) return (num / 1e18).toFixed(2) + ' Quintillion';
        if (num >= 1e15) return (num / 1e15).toFixed(2) + ' Quadrillion';
        if (num >= 1e12) return (num / 1e12).toFixed(2) + ' Trillion';
        if (num >= 1e9) return (num / 1e9).toFixed(2) + ' Billion';
        if (num >= 1e6) return (num / 1e6).toFixed(2) + ' Million';
        if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
        return num.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function updateMoney(amount) {
        gameState.money += amount;
        if (amount > 0) {
            gameState.totalMoneyEarned += amount;
        }
        document.getElementById('money-display').textContent = `üí∞ Money: $${formatNumber(gameState.money)}`;
        checkAchievements('totalMoney', gameState.totalMoneyEarned);
    }
    
    // --- Core Game Logic ---

    function getFish() {
        // Get equipped rod's luck
        const equippedRod = findRod(gameState.equippedRodId);
        const playerLuck = equippedRod ? equippedRod.luck : 0;
    
        // Calculate the total chance (sum of all chances * (1 + luck bonus))
        let totalChance = RARITIES.reduce((sum, r) => sum + r.chance, 0);
        // Apply luck to reduce the chance of lower rarities and increase higher ones
        // A simple linear scale: luck reduces the final random number roll.
        const rollModifier = playerLuck / 10000; // Scale luck down
        
        // Pick a random number between 0 and totalChance
        let roll = Math.random() * totalChance;
        
        // This is a basic way to apply luck. For a better distribution:
        // Adjust the roll to favor higher rarities based on playerLuck
        const luckFactor = 1 + (playerLuck / 1000); // 1,000 luck = 2x chance multiplier
        roll /= luckFactor;

        let cumulativeChance = 0;
        
        // Iterate through rarities from common to ultra-rare
        for (const rarity of RARITIES) {
            
            // For higher rarities, boost their chance relative to the roll
            // This is a simple, if crude, way to apply luck dynamically
            let currentChance = rarity.chance;
            
            if (roll < currentChance) {
                // Determine fish name
                const names = FISH_NAMES[rarity.name];
                const name = names[Math.floor(Math.random() * names.length)];
                
                // Return the caught fish object
                return {
                    name: name,
                    rarity: rarity.name,
                    value: rarity.value,
                    colorClass: rarity.colorClass,
                    icon: rarity.icon,
                };
            }
            // If the roll is higher than this rarity's chance, subtract it and move to the next.
            // Wait, this is not how cumulative chances work. Let's fix the roll logic for a simple array:
            cumulativeChance += rarity.chance;
        }

        // Re-do the roll logic:
        let newTotalChance = RARITIES.reduce((sum, r) => sum + r.chance, 0);
        
        // The overall "luck" will affect the resulting rarity by changing the roll distribution.
        // A lower roll = rarer fish.
        let finalRoll = Math.random() * newTotalChance; 
        
        // Apply luck: a higher player luck effectively lowers the 'roll' value.
        // E.g., at 10000 luck, the luckFactor is 11.0. The roll is divided by this.
        const lureSpeedMultiplier = equippedRod ? equippedRod.lureSpeedMultiplier : 1.0;
        const luckMultiplier = 1 + (playerLuck / 10000); // 10000 luck gives 2x chance to get rarer fish
        finalRoll /= luckMultiplier;

        let newCumulativeChance = 0;
        for (const rarity of RARITIES) {
            newCumulativeChance += rarity.chance;
            if (finalRoll < newCumulativeChance) {
                const names = FISH_NAMES[rarity.name];
                const name = names[Math.floor(Math.random() * names.length)];
                
                return {
                    name: name,
                    rarity: rarity.name,
                    value: rarity.value,
                    colorClass: rarity.colorClass,
                    icon: rarity.icon,
                    lureSpeed: lureSpeedMultiplier,
                };
            }
        }
        
        // Fallback (shouldn't happen with correct percentages)
        const common = findRarity('Common');
        const names = FISH_NAMES['Common'];
        const name = names[Math.floor(Math.random() * names.length)];
        return {
            name: name,
            rarity: 'Common',
            value: common.value,
            colorClass: common.colorClass,
            icon: common.icon,
            lureSpeed: lureSpeedMultiplier,
        };
    }
    
    // --- Minigame Logic ---
    let minigameTimer;
    
    function startMinigame(fish) {
        if (isMinigameActive) return;
        isMinigameActive = true;
        
        const rod = findRod(gameState.equippedRodId);
        const lureSpeed = rod.lureSpeedMultiplier;
        
        // Max progress is now based on fish rarity value (rarer = harder)
        const rarityValue = fish.value;
        let maxClicks = 5 + Math.floor(Math.log10(rarityValue)); // 5 + (0 to ~20) clicks

        // Time limit is shorter for rarer fish, but longer for higher level rods
        let timeLimitSeconds = Math.max(10, 40 - Math.floor(Math.log10(rarityValue) * 3));
        timeLimitSeconds *= (1 / lureSpeed) + 0.5; // Rod reduces the time you have to catch it
        timeLimitSeconds = Math.min(60, timeLimitSeconds); // Max 60 seconds

        // The target area size is fixed, but position is random.
        const targetWidth = 10; // 10% width
        const targetLeft = Math.random() * (100 - targetWidth);

        minigameData = {
            fish: fish,
            progress: 0,
            maxProgress: maxClicks,
            clicksRemaining: maxClicks,
            timeElapsed: 0,
            timeLimit: timeLimitSeconds,
            targetLeft: targetLeft,
            targetRight: targetLeft + targetWidth,
            barSpeed: (100 / timeLimitSeconds) * 10, // Bar moves 10% every second
            lureSpeed: lureSpeed, // Multiplier for reel progress
            win: false,
        };
        
        document.getElementById('target-area').style.width = `${targetWidth}%`;
        document.getElementById('target-area').style.left = `${targetLeft}%`;
        document.getElementById('progress-bar').style.width = '0%';
        document.getElementById('clicks-remaining').textContent = minigameData.clicksRemaining;
        document.getElementById('minigame-feedback').textContent = `Time left: ${minigameData.timeLimit.toFixed(1)}s`;
        
        document.getElementById('minigame-overlay').style.display = 'flex';
        document.getElementById('fishing-button').disabled = true;

        minigameTimer = setInterval(minigameLoop, 100); // 10 times per second
    }

    function minigameLoop() {
        if (!isMinigameActive) {
            clearInterval(minigameTimer);
            return;
        }

        minigameData.timeElapsed += 0.1;

        // Check for time limit loss
        if (minigameData.timeElapsed >= minigameData.timeLimit) {
            endMinigame(false);
            return;
        }
        
        // Update time display
        const timeLeft = minigameData.timeLimit - minigameData.timeElapsed;
        document.getElementById('minigame-feedback').textContent = `Time left: ${timeLeft.toFixed(1)}s`;
    }

    function handleMinigameClick() {
        if (!isMinigameActive) return;
        
        const progressBar = document.getElementById('progress-bar');
        const currentProgress = parseFloat(progressBar.style.width);
        
        // Check if the click is in the target area
        const targetLeft = minigameData.targetLeft;
        const targetRight = minigameData.targetRight;
        
        let success = false;
        
        // If the click is "on the progress bar," it's a success
        if (currentProgress >= targetLeft && currentProgress <= targetRight) {
            success = true;
        }
        
        if (success) {
            // Apply lureSpeed to reel progress
            minigameData.progress += 1 * minigameData.lureSpeed; 
            minigameData.clicksRemaining--;
            
            // Check for minigame win
            if (minigameData.progress >= minigameData.maxProgress) {
                endMinigame(true);
                return;
            }
        } else {
            // Miss: lose progress based on the multiplier
            minigameData.progress = Math.max(0, minigameData.progress - 0.5 * minigameData.lureSpeed);
        }

        // Update progress bar width based on clicks completed vs max clicks
        const newWidth = (minigameData.progress / minigameData.maxProgress) * 100;
        progressBar.style.width = `${Math.min(100, newWidth)}%`;
        document.getElementById('clicks-remaining').textContent = Math.max(0, minigameData.clicksRemaining);
        
        // If clicks remaining hit zero, you fail (unless maxProgress was lower)
        if (minigameData.clicksRemaining <= 0 && minigameData.progress < minigameData.maxProgress) {
             endMinigame(false);
             return;
        }
    }

    function endMinigame(won) {
        clearInterval(minigameTimer);
        isMinigameActive = false;
        document.getElementById('minigame-overlay').style.display = 'none';
        document.getElementById('fishing-button').disabled = false;
        
        const fish = minigameData.fish;
        
        if (won) {
            addFishToInventory(fish);
            const rarityInfo = findRarity(fish.rarity);
            document.getElementById('result').innerHTML = `**üéâ CAUGHT!** You reeled in a <span class="${rarityInfo.colorClass}">${fish.icon} ${fish.name} (${fish.rarity})</span> worth $${formatNumber(fish.value)}!`;
            updateGame(fish);
        } else {
            document.getElementById('result').textContent = `**üò≠ LOST!** The ${fish.name} got away! You couldn't reel it in fast enough.`;
        }
        
        // Reset minigame data
        minigameData = {};
    }


    function reelFish() {
        if (isFishing) return;
        isFishing = true;
        document.getElementById('fishing-button').disabled = true;
        document.getElementById('result').textContent = 'Casting line...';

        // Get a potential fish outcome immediately
        const caughtFish = getFish();

        // Simulate casting time
        setTimeout(() => {
            document.getElementById('result').textContent = 'Waiting for a bite...';
            
            // Simulate waiting/biting time
            setTimeout(() => {
                isFishing = false;
                document.getElementById('result').textContent = `**BITING!** A ${caughtFish.rarity} ${caughtFish.icon} is on the line!`;
                
                // Immediately start the mini-game
                startMinigame(caughtFish);

            }, 2000); // Wait 2 seconds for a bite

        }, 1000); // 1 second cast time
    }
    
    function updateGame(fish) {
        // 1. Update total fish caught and money earned
        gameState.totalFishCaught++;

        // 2. Update Fish Index
        if (!gameState.fishIndex[fish.name]) {
            gameState.fishIndex[fish.name] = true;
            renderFishIndex();
        }

        // 3. Check for Level Up
        gameState.progressToNextLevel++;
        checkLevelUp();
        
        // 4. Check for Achievements
        checkAchievements('catchCount', gameState.totalFishCaught);
        checkAchievements('rarity', fish.rarity);
    }
    
    function checkLevelUp() {
        // Check if current progress meets the goal
        while (gameState.progressToNextLevel >= gameState.fishToNextLevel) {
            // Level Up!
            gameState.currentLevel++;
            gameState.progressToNextLevel -= gameState.fishToNextLevel; // Carry over excess fish
            gameState.fishToNextLevel = Math.floor(BASE_EXP * Math.pow(EXP_GROWTH, gameState.currentLevel - 1));
            
            alert(`üéâ Level Up! You are now Level ${gameState.currentLevel}!`);
        }
        
        // Update Level Display
        const percentage = (gameState.progressToNextLevel / gameState.fishToNextLevel) * 100;
        document.getElementById('current-level').textContent = gameState.currentLevel;
        document.getElementById('level-progress-bar').style.width = `${percentage}%`;
        document.getElementById('progress-text').textContent = `${gameState.progressToNextLevel} / ${gameState.fishToNextLevel} Fish Caught`;
    }
    
    function checkAchievements(type, value) {
        ACHIEVEMENTS.forEach((achievement, index) => {
            if (!gameState.achievements[index].completed) {
                let isCompleted = false;
                
                if (type === 'catchCount' && achievement.type === 'catchCount' && value >= achievement.goal) {
                    isCompleted = true;
                } else if (type === 'totalMoney' && achievement.type === 'totalMoney' && value >= achievement.goal) {
                    isCompleted = true;
                } else if (type === 'rarity' && achievement.type === 'rarity' && value === achievement.goal) {
                    isCompleted = true;
                } else if (type === 'rodOwned' && achievement.type === 'rodOwned') {
                    // Check if the rod is owned
                    const rodOwnedGoal = achievement.goal; // This is the rod ID
                    const rod = findRod(rodOwnedGoal);
                    // Check if the current rod is the goal or if the goal rod is owned.
                    if (gameState.ownedRods.includes(rodOwnedGoal)) {
                        isCompleted = true;
                    }
                    // Special case for 'buy_graphite': check for ANY rod better than or equal to Graphite
                    if (achievement.id === 'buy_graphite') {
                        const graphiteIndex = FISHING_RODS.findIndex(r => r.id === 'graphite');
                        const ownedRodIndexes = gameState.ownedRods.map(rodId => FISHING_RODS.findIndex(r => r.id === rodId));
                        if (ownedRodIndexes.some(i => i >= graphiteIndex)) {
                             isCompleted = true;
                        }
                    }
                }
                
                if (isCompleted) {
                    gameState.achievements[index].completed = true;
                    alert(`‚≠ê Achievement Unlocked: ${achievement.title}!`);
                    renderAchievements();
                }
            }
        });
    }

    // --- Inventory Functions ---
    
    function addFishToInventory(fish) {
        if (!gameState.inventory[fish.name]) {
            gameState.inventory[fish.name] = {
                count: 0,
                rarity: fish.rarity,
                value: fish.value,
                colorClass: fish.colorClass,
                icon: fish.icon,
            };
        }
        gameState.inventory[fish.name].count++;
        renderInventory();
    }
    
    function sellAllFish() {
        let totalEarnings = 0;
        const fishNames = Object.keys(gameState.inventory);
        
        for (const name of fishNames) {
            const item = gameState.inventory[name];
            totalEarnings += item.count * item.value;
        }
        
        if (totalEarnings > 0) {
            updateMoney(totalEarnings);
            gameState.inventory = {}; // Clear inventory
            document.getElementById('result').textContent = `üí∞ Sold all fish for $${formatNumber(totalEarnings)}!`;
            renderInventory();
        } else {
            document.getElementById('result').textContent = `Inventory is empty.`;
        }
    }
    
    // --- Shop/Rods Functions ---

    function buyRod(rodId) {
        const rod = findRod(rodId);
        if (!rod) return;

        if (gameState.money >= rod.cost) {
            updateMoney(-rod.cost); // Subtract cost
            gameState.ownedRods.push(rodId);
            equipRod(rodId); // Auto-equip new rod
            document.getElementById('result').textContent = `‚úÖ Purchased and equipped the **${rod.name}**!`;
            
            renderShop();
            renderRodStats();
            checkAchievements('rodOwned', rodId);
            saveGame();
        } else {
            document.getElementById('result').textContent = `‚ùå Not enough money to buy the ${rod.name}. You need $${formatNumber(rod.cost - gameState.money)} more.`;
        }
    }

    function craftRod(rodId) {
        const rod = findRod(rodId);
        if (!rod || !rod.recipe) return;

        let canCraft = true;
        
        // 1. Check if the player has enough materials
        for (const requirement of rod.recipe) {
            const inventoryFish = gameState.inventory[requirement.name];
            if (!inventoryFish || inventoryFish.count < requirement.required) {
                canCraft = false;
                break;
            }
        }

        if (canCraft) {
            // 2. Consume materials
            for (const requirement of rod.recipe) {
                gameState.inventory[requirement.name].count -= requirement.required;
                if (gameState.inventory[requirement.name].count <= 0) {
                    delete gameState.inventory[requirement.name];
                }
            }
            
            // 3. Grant rod
            gameState.ownedRods.push(rodId);
            equipRod(rodId); // Auto-equip new rod
            
            document.getElementById('result').textContent = `üî® Crafted and equipped the **${rod.name}**!`;
            
            renderShop();
            renderInventory();
            renderRodStats();
            checkAchievements('rodOwned', rodId);
            saveGame();
        } else {
            document.getElementById('result').textContent = `‚ùå Missing materials to craft the ${rod.name}.`;
        }
    }
    
    function equipRod(rodId) {
        const rod = findRod(rodId);
        if (rod && gameState.ownedRods.includes(rodId)) {
            gameState.equippedRodId = rodId;
            renderRodStats();
            renderShop(); // Update the equipped label in the shop
            saveGame();
        }
    }
    
    function openShop() {
        renderShop();
        document.getElementById('shop-overlay').style.display = 'flex';
    }

    function closeShop() {
        document.getElementById('shop-overlay').style.display = 'none';
    }

    // --- Rendering Functions ---

    function renderRodStats() {
        const rod = findRod(gameState.equippedRodId);
        if (rod) {
            const rarity = findRarity(rod.rarity);
            const rodNameSpan = document.getElementById('rod-name');
            rodNameSpan.textContent = rod.name;
            rodNameSpan.className = rod.recipe ? 'rarity-omnipresence' : ''; // Just a default rarity if not set
            document.getElementById('rod-luck').textContent = formatNumber(rod.luck);
            document.getElementById('rod-speed').textContent = `${rod.lureSpeedMultiplier.toFixed(1)}x Reel Progress`;
        }
    }

    function renderInventory() {
        const inventoryList = document.getElementById('fish-list');
        inventoryList.innerHTML = '';
        const sortedFish = Object.values(gameState.inventory)
            .sort((a, b) => b.value - a.value); // Sort by value

        if (sortedFish.length === 0) {
            inventoryList.innerHTML = '<li>Inventory is empty.</li>';
            return;
        }

        for (const item of sortedFish) {
            const li = document.createElement('li');
            li.innerHTML = `<span class="${item.colorClass}">${item.icon} ${item.name} (${item.rarity})</span> x ${formatNumber(item.count)} - $${formatNumber(item.count * item.value)}`;
            inventoryList.appendChild(li);
        }
    }

    function renderFishIndex() {
        const indexList = document.getElementById('index-list');
        indexList.innerHTML = '';
        
        // Flatten all fish names with their properties
        let allFish = [];
        for (const rarity of RARITIES) {
            const names = FISH_NAMES[rarity.name] || [];
            for (const name of names) {
                allFish.push({ ...rarity, name: name });
            }
        }
        
        // Sort by rarity value
        allFish.sort((a, b) => a.value - b.value);

        for (const fish of allFish) {
            const isDiscovered = gameState.fishIndex[fish.name];
            const li = document.createElement('li');
            li.innerHTML = isDiscovered 
                ? `<span class="${fish.colorClass}">${fish.icon} ${fish.name} (${fish.rarity})</span> - Value: $${formatNumber(fish.value)}`
                : `<span style="color:#aaa;">‚ùì Undiscovered Fish</span>`;
            
            indexList.appendChild(li);
        }
    }
    
    function renderShop() {
        const shopList = document.getElementById('shop-items-list');
        const craftingList = document.getElementById('crafting-recipes-list');
        shopList.innerHTML = '';
        craftingList.innerHTML = '';
        
        for (const rod of FISHING_RODS) {
            const isOwned = gameState.ownedRods.includes(rod.id);
            const isEquipped = gameState.equippedRodId === rod.id;
            
            if (rod.cost !== undefined) {
                // --- Purchase Rods ---
                const div = document.createElement('div');
                div.className = 'rod-item';
                div.innerHTML = `
                    <div>
                        <span class="${rod.rarity ? findRarity(rod.rarity).colorClass : ''}">**${rod.name}**</span>
                        <div class="rod-stats">
                            <span>Luck: +${formatNumber(rod.luck)}</span>
                            <span>Speed: ${rod.lureSpeedMultiplier.toFixed(1)}x</span>
                        </div>
                    </div>
                    <div>
                        ${isEquipped 
                            ? `<span class="equipped-label">Equipped</span>`
                            : isOwned 
                                ? `<button class="buy-button" onclick="equipRod('${rod.id}')">Equip</button>`
                                : `<button class="buy-button" ${gameState.money >= rod.cost ? '' : 'disabled'} onclick="buyRod('${rod.id}')">Buy ($${formatNumber(rod.cost)})</button>`
                        }
                    </div>
                `;
                shopList.appendChild(div);

            } else if (rod.recipe) {
                // --- Craftable Rods ---
                let canCraft = true;
                const recipeHTML = rod.recipe.map(req => {
                    const fishInInventory = gameState.inventory[req.name] ? gameState.inventory[req.name].count : 0;
                    const hasEnough = fishInInventory >= req.required;
                    if (!hasEnough) canCraft = false;
                    const colorClass = findRarity(req.rarity).colorClass;
                    return `<span style="color:${hasEnough ? 'green' : 'red'};">${formatNumber(fishInInventory)}/${formatNumber(req.required)}</span> <span class="${colorClass}">${req.name}</span>`;
                }).join(' / ');
                
                const div = document.createElement('div');
                div.className = 'rod-item';
                div.innerHTML = `
                    <div>
                        <span class="craft-title ${rod.rarity ? findRarity(rod.rarity).colorClass : ''}">**${rod.name}**</span>
                        <div class="rod-stats">
                            <span>Luck: +${formatNumber(rod.luck)}</span>
                            <span>Speed: ${rod.lureSpeedMultiplier.toFixed(1)}x</span>
                        </div>
                        <div class="recipe-materials">Requires: ${recipeHTML}</div>
                    </div>
                    <div>
                        ${isEquipped 
                            ? `<span class="equipped-label">Equipped</span>`
                            : isOwned 
                                ? `<button class="buy-button" onclick="equipRod('${rod.id}')">Equip</button>`
                                : `<button class="craft-button" ${canCraft ? '' : 'disabled'} onclick="craftRod('${rod.id}')">Craft</button>`
                        }
                    </div>
                `;
                craftingList.appendChild(div);
            }
        }
    }
    
    function renderAchievements() {
        const achievementListDiv = document.getElementById('achievements-list');
        achievementListDiv.innerHTML = '';

        for (let i = 0; i < ACHIEVEMENTS.length; i++) {
            const achievement = ACHIEVEMENTS[i];
            const state = gameState.achievements.find(a => a.id === achievement.id) || { completed: false };

            const div = document.createElement('div');
            div.className = `achievement-item ${state.completed ? 'completed' : ''}`;
            
            let statusText = state.completed ? 'COMPLETED' : 'LOCKED';
            let progressStatus = '';

            if (!state.completed) {
                if (achievement.type === 'catchCount') {
                    progressStatus = `${formatNumber(gameState.totalFishCaught)}/${formatNumber(achievement.goal)}`;
                } else if (achievement.type === 'totalMoney') {
                    progressStatus = `$${formatNumber(gameState.totalMoneyEarned)}/$${formatNumber(achievement.goal)}`;
                }
                statusText = progressStatus || 'LOCKED';
            }
            
            div.innerHTML = `
                <span class="achievement-icon">${achievement.icon}</span>
                <div>
                    <div class="achievement-title">${achievement.title}</div>
                    <div class="achievement-desc">${achievement.desc}</div>
                </div>
                <div class="achievement-status">${statusText}</div>
            `;
            achievementListDiv.appendChild(div);
        }
    }

    // --- Save/Load Functions ---

    function saveGame() {
        try {
            localStorage.setItem('fishingClickerRPGSave', JSON.stringify(gameState));
            document.getElementById('result').textContent = 'üíæ Game Saved!';
        } catch (e) {
            console.error("Error saving game:", e);
            document.getElementById('result').textContent = '‚ùå Failed to save game!';
        }
    }
    
    function loadGame() {
        try {
            const savedState = localStorage.getItem('fishingClickerRPGSave');
            if (savedState) {
                const loadedState = JSON.parse(savedState);
                
                // Merge loaded state with current state to handle new properties (like new rods or achievements)
                gameState = { 
                    ...gameState, 
                    ...loadedState,
                    // Ensure new achievements are present but not completed unless in the save
                    achievements: ACHIEVEMENTS.map(newAch => {
                        const savedAch = loadedState.achievements.find(a => a.id === newAch.id);
                        return { id: newAch.id, completed: savedAch ? savedAch.completed : newAch.completed };
                    }),
                };
                
                // Ensure number types are restored correctly from string, especially for large numbers
                gameState.money = Number(gameState.money);
                gameState.totalMoneyEarned = Number(gameState.totalMoneyEarned);
                gameState.totalFishCaught = Number(gameState.totalFishCaught);
                gameState.currentLevel = Number(gameState.currentLevel);
                gameState.fishToNextLevel = Number(gameState.fishToNextLevel);
                gameState.progressToNextLevel = Number(gameState.progressToNextLevel);
                
                // Re-calculate fish to next level to ensure consistency with current formula
                gameState.fishToNextLevel = Math.floor(BASE_EXP * Math.pow(EXP_GROWTH, gameState.currentLevel - 1));

                document.getElementById('result').textContent = '‚úÖ Game Loaded!';
                return true;
            }
        } catch (e) {
            console.error("Error loading game:", e);
            document.getElementById('result').textContent = '‚ùå Failed to load game. Starting new game.';
        }
        return false;
    }

    // --- Initialization ---

    function initializeGame() {
        loadGame();
        
        // Initial rendering
        updateMoney(0); // This also updates the totalMoneyEarned display
        renderRodStats();
        renderInventory();
        renderFishIndex();
        renderAchievements();
        checkLevelUp(); // This updates the level bar and text

        // Event Listeners
        document.getElementById('fishing-button').addEventListener('click', reelFish);
        document.getElementById('sell-all-button').addEventListener('click', sellAllFish);
        document.getElementById('shop-button').addEventListener('click', openShop);
        document.getElementById('minigame-button').addEventListener('click', handleMinigameClick);
        document.getElementById('save-button').addEventListener('click', saveGame);
        
        // Periodically auto-save
        // setInterval(saveGame, 60000); // Auto-save every 60 seconds
    }

    // Start the game once the script is loaded
    initializeGame();

</script>

</body>
</html>