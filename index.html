<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Clicker Fishing Game - Full Version</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f8ff;
            margin: 0;
            color: #333;
        }

        #game-container {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 550px;
            margin-bottom: 20px;
        }

        #fishing-button {
            padding: 15px 30px;
            font-size: 20px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.1s;
        }

        #fishing-button:hover {
            background-color: #45a049;
        }

        #fishing-button:active {
            transform: scale(0.98);
        }

        #result {
            margin-top: 20px;
            font-size: 18px;
            min-height: 50px;
        }

        #inventory, #money-display, #current-rod, #fish-index, #level-display, #achievements-list-container {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            text-align: left;
            background: #fafafa;
        }
        
        /* LEVEL DISPLAY */
        #level-display {
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            background-color: #ffe0b2;
            padding: 15px 10px;
        }

        #progress-container {
            width: 100%;
            height: 15px;
            background-color: #ddd;
            border-radius: 7px;
            margin-top: 5px;
            overflow: hidden;
        }

        #level-progress-bar {
            height: 100%;
            width: 0%;
            background-color: #ff9800;
            transition: width 0.3s ease-out;
        }

        #progress-text {
            font-size: 0.8em;
            margin-top: 3px;
            color: #555;
        }


        #money-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #2196F3;
            text-align: center;
        }

        #current-rod {
            font-size: 0.9em;
            text-align: center;
            background-color: #e0f7fa;
        }

        /* Rarity Classes (OLD) */
        .rarity-common { color: #555; }
        .rarity-uncommon { color: #008000; }
        .rarity-rare { color: #0000ff; }
        .rarity-epic { color: #a020f0; } 
        .rarity-legendary { color: #800080; }
        .rarity-mythic { color: #ff8c00; }
        .rarity-exotic { color: #ffd700; } 
        .rarity-secret { color: #ff69b4; }
        .rarity-depthful { color: #005f73; font-weight: bold; }
        .rarity-ethereal { color: #9d4edd; font-weight: bold; }
        .rarity-cosmic { color: #ff006e; font-weight: bold; }
        .rarity-void { color: #1e1e1e; background-color: #aaa; color: #fff; } 
        .rarity-temporal { color: #ff4500; font-weight: bold; } 
        .rarity-chromatic { color: #ff00ff; font-weight: bold; } 
        .rarity-primal { color: #a0522d; font-weight: bold; } 
        .rarity-celestial { color: #4682b4; font-weight: bold; } 
        .rarity-divine { color: #daa520; font-weight: bold; } 
        .rarity-legendary-x { color: #ff0000; font-weight: bold; } 
        .rarity-ultimate { color: #00ffff; font-weight: bold; } 
        .rarity-astral { color: #7fff00; font-weight: bold; } 
        .rarity-cosmic-horror { color: #6f2dbf; font-weight: bold; } 
        .rarity-omega { color: #f0f8ff; background-color: #000; font-weight: bold; } 
        .rarity-apex { color: #dc143c; }
        .rarity-dimensional { color: #00bfff; font-weight: bold; } 
        .rarity-reality { color: #ffc0cb; font-weight: bold; background-color: #800000; }
        .rarity-singularity { color: #000; background-color: #fff; font-weight: bold; border: 2px solid #000; }

        /* --- NEW RARITY COLORS --- */
        .rarity-existence { color: #fff; background-color: #000080; font-weight: bold; border: 2px solid #000; } /* Dark Blue/Navy */
        .rarity-omnipresence { color: #ff00ff; font-weight: bold; background-color: #333; } /* Magenta on Grey */
        .rarity-origin { color: #ff4500; font-weight: bold; border: 2px solid #ff4500; } /* Orange */
        .rarity-pinnacle { color: #00ffff; font-weight: bold; background-color: #800000; } /* Cyan on Maroon */
        .rarity-eternal { color: #ffd700; font-weight: bold; background-color: #000000; } /* Gold on Black - NEW TOP TIER */


        /* --- Shop/Crafting Styles --- */
        #shop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        #shop-box {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .shop-section {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .shop-section h4 {
            margin-top: 0;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .rod-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rod-stats span {
            margin-right: 10px;
            font-size: 0.9em;
            color: #555;
        }
        
        .buy-button {
            padding: 8px 15px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.2s;
            min-width: 90px;
        }

        .buy-button:hover:not(:disabled) {
            background-color: #218838;
        }
        
        .buy-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .equipped-label {
            color: #007bff;
            font-weight: bold;
            min-width: 90px;
        }

        .craft-recipe {
            border: 1px solid #ff9800;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            text-align: left;
        }
        .craft-recipe strong {
            display: block;
            margin-bottom: 5px;
        }
        .recipe-materials {
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .recipe-materials span {
            display: inline-block;
            margin-right: 10px;
        }
        .craft-button {
            padding: 8px 15px;
            cursor: pointer;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
        }
        
        /* --- Mini-Game Overlay Styles --- */
        #minigame-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #minigame-box {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        #progress-bar-container {
            width: 250px;
            height: 20px;
            background-color: #eee;
            border-radius: 10px;
            margin: 15px auto;
            position: relative;
            border: 1px solid #aaa;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background-color: #4CAF50;
            border-radius: 10px;
            transition: width 0.1s linear;
        }

        #target-area {
            position: absolute;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.4);
            left: 50%;
            width: 20%;
            top: 0;
            border-left: 2px solid red;
            border-right: 2px solid red;
        }

        #minigame-button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            margin-top: 10px;
        }

        /* Achievements Styles */
        .achievement-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #ffe;
        }
        .achievement-item.completed {
            background-color: #e6ffe6;
            border-color: #4CAF50;
        }
        .achievement-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }
        .achievement-title {
            font-weight: bold;
        }
        .achievement-desc {
            font-size: 0.85em;
            color: #555;
        }
        .achievement-status {
            font-weight: bold;
            color: #dc3545;
        }
        .achievement-item.completed .achievement-status {
            color: #4CAF50;
        }
    </style>
</head>
<body>

<div id="game-container">
    <h2>üåä Ultimate Clicker Fishing Game üêü</h2>
    
    <div id="level-display">
        Level <span id="current-level">1</span>
        <div id="progress-container">
            <div id="level-progress-bar"></div>
        </div>
        <div id="progress-text">0 / 50 Fish Caught</div>
    </div>

    <div id="money-display">üí∞ Money: $0</div>
    
    <div id="current-rod">
        üé£ Current Rod: <span id="rod-name">Basic Rod</span> (Luck: <span id="rod-luck">0</span>, Lure Speed: <span id="rod-speed">1.0x Reel Progress</span>)
    </div>

    <div id="button-group">
        <button id="fishing-button">Click to Fish!</button>
        <button id="shop-button">üõí Open Shop</button>
        <button id="save-button" style="background-color:#007bff;">üíæ Save Game</button>
    </div>

    <div id="result">Waiting for a bite...</div>

    <div id="inventory">
        <h3>Inventory</h3>
        <ul id="fish-list">
            </ul>
        <button id="sell-all-button">Sell All Fish</button>
    </div>

    <div id="fish-index">
        <h3>Fish Index (Discovered)</h3>
        <ul id="index-list">
            </ul>
    </div>

    <div id="achievements-list-container">
        <h3>üèÜ Achievements</h3>
        <div id="achievements-list">
            </div>
    </div>
</div>

<div id="shop-overlay">
    <div id="shop-box">

        <div class="shop-section">
            <h4>üí∞ Purchase Rods</h4>
            <p>Buy entry-level rods directly with money.</p>
            <div id="shop-items-list">
                </div>
        </div>

        <div class="shop-section">
            <h4>üõ†Ô∏è Crafting Station</h4>
            <p>Craft advanced rods using rare fish from your inventory.</p>
            <div id="crafting-recipes-list">
                </div>
        </div>

        <button class="buy-button" style="background-color: #6c757d; width: 100%;" onclick="closeShop()">Close Shop</button>
    </div>
</div>

<div id="minigame-overlay">
    <div id="minigame-box">
        <h3>Mini-Game: Reel it In!</h3>
        <p>Click the button repeatedly when the progress bar is inside the **red target zone** to catch the fish!</p>
        
        <div id="progress-bar-container">
            <div id="target-area"></div>
            <div id="progress-bar"></div>
        </div>

        <p id="minigame-feedback"></p>
        <button id="minigame-button">REEL!</button>
    </div>
</div>

<script>
    // --- Configuration ---
    const RARITIES = [
        // Rarity Order is defined here, from least rare to most rare
        { name: 'Common', chance: 70, colorClass: 'rarity-common', value: 10 },
        { name: 'Uncommon', chance: 15, colorClass: 'rarity-uncommon', value: 30 },
        { name: 'Rare', chance: 8, colorClass: 'rarity-rare', value: 80 },
        { name: 'Epic', chance: 3, colorClass: 'rarity-epic', value: 250 }, 
        { name: 'Legendary', chance: 2, colorClass: 'rarity-legendary', value: 750 },
        { name: 'Mythic', chance: 1, colorClass: 'rarity-mythic', value: 2000 },
        { name: 'Exotic', chance: 0.5, colorClass: 'rarity-exotic', value: 6000 }, 
        { name: 'Secret', chance: 0.25, colorClass: 'rarity-secret', value: 15000 },
        { name: 'Depthful', chance: 0.2, colorClass: 'rarity-depthful', value: 50000 },
        { name: 'Ethereal', chance: 0.1, colorClass: 'rarity-ethereal', value: 150000 },
        { name: 'Cosmic', chance: 0.05, colorClass: 'rarity-cosmic', value: 500000 },
        { name: 'Void', chance: 0.025, colorClass: 'rarity-void', value: 1500000 },
        { name: 'Temporal', chance: 0.015, colorClass: 'rarity-temporal', value: 4000000 },
        { name: 'Chromatic', chance: 0.01, colorClass: 'rarity-chromatic', value: 10000000 },
        { name: 'Primal', chance: 0.007, colorClass: 'rarity-primal', value: 25000000 },
        { name: 'Celestial', chance: 0.005, colorClass: 'rarity-celestial', value: 60000000 },
        { name: 'Divine', chance: 0.003, colorClass: 'rarity-divine', value: 150000000 },
        { name: 'Legendary X', chance: 0.002, colorClass: 'rarity-legendary-x', value: 400000000 },
        { name: 'Ultimate', chance: 0.001, colorClass: 'rarity-ultimate', value: 1000000000 },
        { name: 'Astral', chance: 0.0005, colorClass: 'rarity-astral', value: 7000000000 }, 
        { name: 'Cosmic Horror', chance: 0.00025, colorClass: 'rarity-cosmic-horror', value: 35000000000 }, 
        { name: 'Omega', chance: 0.0001, colorClass: 'rarity-omega', value: 200000000000 }, 
        { name: 'Apex', chance: 0.00005, colorClass: 'rarity-apex', value: 1000000000000 }, 
        { name: 'Dimensional', chance: 0.00002, colorClass: 'rarity-dimensional', value: 150000000000000 }, 
        { name: 'Reality', chance: 0.000005, colorClass: 'rarity-reality', value: 400000000000000 },
        
        { name: 'Singularity', chance: 0.000001, colorClass: 'rarity-singularity', value: 1000000000000000 }, // PREVIOUS TOP

        // --- NEW TOP RARITIES INSERTED HERE (5) ---
        { name: 'Existence', chance: 0.0000005, colorClass: 'rarity-existence', value: 5000000000000000 },
        { name: 'Omnipresence', chance: 0.0000002, colorClass: 'rarity-omnipresence', value: 25000000000000000 },
        { name: 'Origin', chance: 0.00000008, colorClass: 'rarity-origin', value: 100000000000000000 },
        { name: 'Pinnacle', chance: 0.00000002, colorClass: 'rarity-pinnacle', value: 500000000000000000 },
        { name: 'Eternal', chance: 0.000000005, colorClass: 'rarity-eternal', value: 2000000000000000000 }, // NEW ABSOLUTE TOP
        // --- END NEW RARITIES ---
        
    ].sort((a, b) => b.chance - a.chance);

    const FISH_NAMES = {
        'Common': ['Minnow', 'Trout', 'Bass', 'Sardine', 'Anchovy', 'Cod', 'Flounder', 'Prawn'],
        'Uncommon': ['Perch', 'Carp', 'Catfish', 'Haddock', 'Snapper', 'Mackerel', 'Bluegill', 'Goby'],
        'Rare': ['Salmon', 'Eel', 'Pike', 'Halibut', 'Tuna', 'Dolphin Fish', 'Redfish', 'Sea Bass'],
        'Epic': ['Mahi-Mahi', 'Kingfish', 'Barracuda', 'Grouper', 'Wahoo', 'Albacore', 'Amberjack'], 
        'Legendary': ['Blue Marlin', 'Swordfish', 'Giant Squid', 'Opah', 'Viperfish', 'Arapaima'],
        'Mythic': ['Kraken Trout', 'Sunken Shark', 'Nessie Bass', 'Siren Salmon', 'Phantom Eel', 'Giga Ray'],
        'Exotic': ['Abyssal Dragonfish', 'Void Ray', 'Crystal Cod', 'Lava Bass', 'Electric Flounder', 'Shadow Salmon'],
        'Secret': ['Cosmic Jellyfish', 'Ethereal Blob', 'Time Trout', 'Ghost Mackerel', 'Dream Tilapia'],
        'Depthful': [
            'Shadow Fin', 'Glow Whale', 'Deep Sea Angler', 'Chasm Shark', 'Crag Cod', 'Onyx Bass', 
            'Trench Eel', 'Midnight Flounder', 'Pressure Carp'
        ],
        'Ethereal': [
            'Whisper Eel', 'Astral Shrimp', 'Phantom Flounder', 'Mist Marlin', 'Aurora Trout', 'Spirit Carp',
            'Specter Salmon', 'Vapor Whale'
        ],
        'Cosmic': [
            'Stardust Ray', 'Nebula Tetra', 'Galactic Grouper', 'Comet Carp', 'Black Hole Bass', 'Quasar Fish',
            'Void Starfish', 'Wormhole Wrasse'
        ],
        'Void': [
            'Empty Fin', 'Null Clam', 'Zero Cod', 'Entropy Eel',
            'Non-Existent Tuna', 'Oblivion Prawn'
        ],
        'Temporal': [
            'Clockwork Trout', 'Epoch Bass', 'Momentary Pike', 'Chrono Flounder',
            'Relic Salmon', 'Past Perch'
        ],
        'Chromatic': [
            'Rainbow Minnow', 'Prism Shark', 'Spectrum Bass', 'Iridescent Wrasse',
            'Holo Ray', 'Lightwave Ling'
        ],
        'Primal': [
            'Dinosaur Sturgeon', 'Tar Pit Perch', 'Ancient Carp', 'Fossil Fin',
            'Stone Scale', 'Magmafin'
        ],
        'Celestial': [
            'Sunfish', 'Moon Trout', 'Planet Prawn', 'Starfish',
            'Zodiac Carp', 'Orion Grouper'
        ],
        'Divine': [
            'Godly Bass', 'Angel Fin', 'Holy Mackerel', 'Seraphim Salmon',
            'Halo Haddock', 'Olympus Eel'
        ],
        'Legendary X': [
            'The One That Got Away', 'Infinite Eel', 'Ultimate Squid',
            'The Uncatchable', 'Fate Fin'
        ],
        'Ultimate': [
            'The Creator Cod', 'Omni-Bass', 'Final Fin', 
            'Alpha Sturgeon', 'Grand Kraken'
        ],
        'Astral': [ 
            'Idea Fish', 'Concept Carp', 'Dream Leviathan', 
            'Thought Trout', 'Pure Entity', 'Starlight Trout', 'Cosmic Flounder'
        ],
        'Cosmic Horror': [ 
            'The World Eater', 'The Fin of Fate', 'The Destroyer', 
            'World Serpent', 'Titan Shark', 'Existential Cod'
        ],
        'Omega': [ 
            'Primordial Leviathan', 'Oceanius Rex', 'Absolute Zero Fin', 
            'God Hand Ray', 'Void Essence Bass' 
        ],
        'Apex': [ 
            'Omega Trout', 'Apex Predator Shark', 'Final Boss Cod', 
            'Infinity Fish', 'Dimensional Carp' 
        ],
        'Dimensional': [ 
            'Hyperspace Tuna', 'Quantum Shark', 'Paradox Pike',
            'Multiverse Ray', 'Mirror Fish'
        ],
        'Reality': [ 
            'The Editor', 'The Source Cod', 'Pattern Shark',
            'Law of Physics Fish', 'True Form Eel'
        ],
        'Singularity': [ 
            'The Unseen', 'Final Entity', 'Perfect Fish',
            'Absolute Zero', 'Origin'
        ],
        // --- NEW FISH NAMES (5) ---
        'Existence': [ 
            'Omnipotent Trout', 'Axiom Prawn', 'Logic Eel',
            'The Definition', 'First Cause Carp'
        ],
        'Omnipresence': [ 
            'Everywhere Fin', 'Timeless Tuna', 'Ubiquitous Shark',
            'The Observer', 'Fourth Dimension Ray'
        ],
        'Origin': [ 
            'Big Bang Bass', 'Seed Salmon', 'Protogenesis Pike',
            'First Light Flounder', 'The Beginning'
        ],
        'Pinnacle': [ 
            'Zenith Eel', 'The Apex Point', 'Acme Angler',
            'Summit Sturgeon', 'Ultimate Zenith'
        ],
        'Eternal': [ 
            'Infinite Carp', 'Forever Fin', 'Aion Bass',
            'Eternity Eel', 'The Unending'
        ],
    };
    
    // Rods 
    const FISHING_RODS = [
        // Original Purchase Rods
        { id: 'basic', name: 'Basic Rod', cost: 0, luck: 0, lureSpeedMultiplier: 1.0 },
        { id: 'wood', name: 'Wooden Rod', cost: 100, luck: 5, lureSpeedMultiplier: 1.2 },
        { id: 'steel', name: 'Steel Rod', cost: 500, luck: 10, lureSpeedMultiplier: 1.5 },
        { id: 'carbon', name: 'Carbon Rod', cost: 2500, luck: 20, lureSpeedMultiplier: 2.0 },
        { id: 'titanium', name: 'Titanium Rod', cost: 10000, luck: 40, lureSpeedMultiplier: 2.5 },
        { id: 'diamond', name: 'Diamond Rod', cost: 50000, luck: 75, lureSpeedMultiplier: 3.5 },
        { id: 'master', name: 'Master Rod', cost: 150000, luck: 120, lureSpeedMultiplier: 5.0 },
        { id: 'quantum', name: 'Quantum Rod', cost: 500000, luck: 200, lureSpeedMultiplier: 7.0 }, 
        { id: 'fiber', name: 'Fiber Rod', cost: 1500000, luck: 300, lureSpeedMultiplier: 8.5 },
        { id: 'polymer', name: 'Polymer Rod', cost: 4000000, luck: 450, lureSpeedMultiplier: 10.0 },
        { id: 'magma', name: 'Magma Rod', cost: 8000000, luck: 600, lureSpeedMultiplier: 12.0 },
        { id: 'energy', name: 'Energy Rod', cost: 15000000, luck: 800, lureSpeedMultiplier: 15.0 },
        { id: 'void_steel', name: 'Void Steel Rod', cost: 30000000, luck: 1100, lureSpeedMultiplier: 19.0 },
        { id: 'chrono', name: 'Chrono Rod', cost: 50000000, luck: 1500, lureSpeedMultiplier: 25.0 },
        { id: 'stellar', name: 'Stellar Rod', cost: 80000000, luck: 2000, lureSpeedMultiplier: 32.0 },
        { id: 'galactic', name: 'Galactic Rod', cost: 120000000, luck: 2600, lureSpeedMultiplier: 40.0 },
        { id: 'universal', name: 'Universal Rod', cost: 200000000, luck: 3500, lureSpeedMultiplier: 50.0 },
        { id: 'pinnacle', name: 'Pinnacle Rod', cost: 500000000, luck: 5000, lureSpeedMultiplier: 75.0 },
        
        // --- NEW PURCHASE RODS (7) ---
        { id: 'cosmic_string', name: 'Cosmic String Rod', cost: 1500000000, luck: 7500, lureSpeedMultiplier: 100.0 },
        { id: 'dark_matter', name: 'Dark Matter Rod', cost: 5000000000, luck: 12000, lureSpeedMultiplier: 140.0 },
        { id: 'event_horizon', name: 'Event Horizon Rod', cost: 15000000000, luck: 20000, lureSpeedMultiplier: 200.0 },
        { id: 'hyperion', name: 'Hyperion Rod', cost: 40000000000, luck: 35000, lureSpeedMultiplier: 280.0 },
        { id: 'aetherium', name: 'Aetherium Rod', cost: 100000000000, luck: 60000, lureSpeedMultiplier: 400.0 },
        { id: 'infinite', name: 'Infinite Loop Rod', cost: 250000000000, luck: 100000, lureSpeedMultiplier: 600.0 },
        { id: 'creator', name: 'Creator‚Äôs Quill Rod', cost: 500000000000, luck: 150000, lureSpeedMultiplier: 800.0 },

        // CRAFTABLE RODS 
        { id: 'celestial', name: 'Celestial Rod', luck: 350, lureSpeedMultiplier: 10.0, 
            recipe: [
                { rarity: 'Mythic', name: 'Kraken Trout', required: 1 },
                { rarity: 'Exotic', name: 'Crystal Cod', required: 1 },
                { rarity: 'Secret', name: 'Cosmic Jellyfish', required: 1 }
            ]
        },
        { id: 'abyssal', name: 'Abyssal Rod', luck: 600, lureSpeedMultiplier: 15.0, 
            recipe: [
                { rarity: 'Depthful', name: 'Deep Sea Angler', required: 2 },
                { rarity: 'Ethereal', name: 'Phantom Flounder', required: 1 },
                { rarity: 'Cosmic', name: 'Nebula Tetra', required: 1 }
            ]
        },
        { id: 'chrono_weave', name: 'Chrono-Weave Rod', luck: 1000, lureSpeedMultiplier: 22.0, 
            recipe: [
                { rarity: 'Void', name: 'Empty Fin', required: 2 },
                { rarity: 'Temporal', name: 'Clockwork Trout', required: 1 }
            ]
        },
        { id: 'aura', name: 'Aura Rod', luck: 1800, lureSpeedMultiplier: 35.0, 
            recipe: [
                { rarity: 'Chromatic', name: 'Prism Shark', required: 2 },
                { rarity: 'Celestial', name: 'Sunfish', required: 1 }
            ]
        },
        { id: 'mythos', name: 'Mythos Rod', luck: 2800, lureSpeedMultiplier: 55.0, 
            recipe: [
                { rarity: 'Primal', name: 'Dinosaur Sturgeon', required: 1 },
                { rarity: 'Divine', name: 'Godly Bass', required: 1 }
            ]
        },
        { id: 'omni', name: 'Omni Rod', luck: 4000, lureSpeedMultiplier: 70.0, 
            recipe: [
                { rarity: 'Legendary X', name: 'The One That Got Away', required: 1 },
                { rarity: 'Celestial', name: 'Moon Trout', required: 1 },
                { rarity: 'Divine', name: 'Angel Fin', required: 1 }
            ]
        },
        { id: 'god', name: 'Rod of the Gods', luck: 7500, lureSpeedMultiplier: 120.0, 
            recipe: [
                { rarity: 'Ultimate', name: 'The Creator Cod', required: 1 },
                { rarity: 'Astral', name: 'Idea Fish', required: 1 }, 
                { rarity: 'Cosmic Horror', name: 'The World Eater', required: 1 }
            ]
        },
        { id: 'apex_lure', name: 'Apex Lure Rod', luck: 15000, lureSpeedMultiplier: 200.0, 
            recipe: [
                { rarity: 'Omega', name: 'Primordial Leviathan', required: 2 }, 
                { rarity: 'Dimensional', name: 'Hyperspace Tuna', required: 1 }, 
                { rarity: 'Apex', name: 'Apex Predator Shark', required: 1 } 
            ]
        },
        { id: 'singularity_core', name: 'Singularity Core Rod', luck: 30000, lureSpeedMultiplier: 350.0, 
            recipe: [
                { rarity: 'Reality', name: 'The Editor', required: 2 },
                { rarity: 'Singularity', name: 'The Unseen', required: 1 }
            ]
        },
        
        // --- NEW CRAFTABLE RODS (7) ---
        { id: 'existential_line', name: 'Existential Line Rod', luck: 60000, lureSpeedMultiplier: 500.0, 
            recipe: [
                { rarity: 'Singularity', name: 'Perfect Fish', required: 2 },
                { rarity: 'Existence', name: 'Omnipotent Trout', required: 1 }
            ]
        },
        { id: 'omni_filament', name: 'Omni-Filament Rod', luck: 120000, lureSpeedMultiplier: 750.0, 
            recipe: [
                { rarity: 'Existence', name: 'Logic Eel', required: 2 },
                { rarity: 'Omnipresence', name: 'Timeless Tuna', required: 1 }
            ]
        },
        { id: 'primordial_reel', name: 'Primordial Reel Rod', luck: 250000, lureSpeedMultiplier: 1200.0, 
            recipe: [
                { rarity: 'Omnipresence', name: 'Everywhere Fin', required: 2 },
                { rarity: 'Origin', name: 'Big Bang Bass', required: 1 }
            ]
        },
        { id: 'zenith_caster', name: 'Zenith Caster Rod', luck: 500000, lureSpeedMultiplier: 2000.0, 
            recipe: [
                { rarity: 'Origin', name: 'The Beginning', required: 2 },
                { rarity: 'Pinnacle', name: 'The Apex Point', required: 1 }
            ]
        },
        { id: 'eternal_weave', name: 'Eternal Weave Rod', luck: 1000000, lureSpeedMultiplier: 3500.0, 
            recipe: [
                { rarity: 'Pinnacle', name: 'Ultimate Zenith', required: 2 },
                { rarity: 'Eternal', name: 'Infinite Carp', required: 1 }
            ]
        },
        { id: 'absolute_hook', name: 'Absolute Hook Rod', luck: 2000000, lureSpeedMultiplier: 6000.0, 
            recipe: [
                { rarity: 'Eternal', name: 'Eternity Eel', required: 2 },
                { rarity: 'Eternal', name: 'Forever Fin', required: 2 }
            ]
        },
        { id: 'final_destiny', name: 'Final Destiny Rod', luck: 5000000, lureSpeedMultiplier: 10000.0, 
            recipe: [
                { rarity: 'Eternal', name: 'Aion Bass', required: 3 },
                { rarity: 'Origin', name: 'Seed Salmon', required: 1 }
            ]
        },
        
        // Reward Rod (Hidden from shop, only unlocked via achievement)
        { id: 'triversal', name: 'Triversal Rod', luck: 90000, lureSpeedMultiplier: 1000.0, isReward: true }, 
    ];

    // --- ACHIEVEMENTS CONFIGURATION ---
    const ALL_RARITY_NAMES = RARITIES.map(r => r.name);
    const ALL_ROD_IDS = FISHING_RODS.filter(r => !r.isReward).map(r => r.id); 

    const ACHIEVEMENTS_LIST = [
        // Standard Achievements
        { id: 'money1k', type: 'money', goal: 1000, title: 'Penny Pincher', description: 'Own your first $1,000.', icon: 'üí∞' },
        { id: 'money100k', type: 'money', goal: 100000, title: 'Wealthy Whistler', description: 'Accumulate $100K in savings.', icon: 'üíµ' },
        { id: 'money1b', type: 'money', goal: 1000000000, title: 'Billionaire Broker', description: 'Break the Billion dollar mark!', icon: 'ü§ë' },
        { id: 'money1trillion', type: 'money', goal: 1000000000000, title: 'Trillionaire Tycoon', description: 'Accumulate $1 Trillion!', icon: 'üëë' },
        
        { id: 'level10', type: 'level', goal: 10, title: 'Novice Angler', description: 'Reach player Level 10.', icon: '‚ú®' },
        { id: 'level50', type: 'level', goal: 50, title: 'Seasoned Veteran', description: 'Reach player Level 50.', icon: 'üåü' },
        { id: 'level100', type: 'level', goal: 100, title: 'Master Baiter', description: 'Reach player Level 100.', icon: 'üåä' },

        { id: 'catch100', type: 'fishCaught', goal: 100, title: 'Century Club', description: 'Catch 100 total fish.', icon: 'üé£' },
        { id: 'catch1000', type: 'fishCaught', goal: 1000, title: 'Grand Haul', description: 'Catch 1,000 total fish.', icon: 'üêü' },

        { id: 'rarityMythic', type: 'rarity', goal: 'Mythic', title: 'Myth Hunter', description: 'Discover a Mythic rarity fish.', icon: 'üîÆ' },
        { id: 'rarityCosmic', type: 'rarity', goal: 'Cosmic', title: 'Cosmic Collector', description: 'Discover a Cosmic rarity fish.', icon: 'üåå' },
        { id: 'rarityUltimate', type: 'rarity', goal: 'Ultimate', title: 'Ultimate Haul', description: 'Discover an Ultimate rarity fish.', icon: 'üëë' },
        { id: 'raritySingularity', type: 'rarity', goal: 'Singularity', title: 'The Void Gazer', description: 'Discover a Singularity rarity fish.', icon: '‚ö´' },
        { id: 'rarityEternal', type: 'rarity', goal: 'Eternal', title: 'Eternal Fisherman', description: 'Discover an Eternal rarity fish (the current best).', icon: '‚ôæÔ∏è' },

        { id: 'rodTitanium', type: 'rod', goal: 'titanium', title: 'Deep Diver', description: 'Equip the Titanium Rod.', icon: 'üõ†Ô∏è' },
        { id: 'rodOmni', type: 'rod', goal: 'omni', title: 'Rod Master', description: 'Equip the Omni Rod.', icon: 'üî±' },
        { id: 'rodSingularity', type: 'rod', goal: 'singularity_core', title: 'The Core Weaver', description: 'Equip the Singularity Core Rod.', icon: 'üî•' },
        { id: 'rodEternal', type: 'rod', goal: 'eternal_weave', title: 'The Unraveler', description: 'Equip the Eternal Weave Rod.', icon: 'üßµ' },


        // Collection Achievements (Goals updated)
        { id: 'rarityRampage', type: 'collection', goal: ALL_RARITY_NAMES, title: 'Rarity Rampage', description: 'Discover at least one fish from every rarity tier.', icon: 'üåÄ' },
        { id: 'allRods', type: 'collection', goal: ALL_ROD_IDS, title: 'Rods and Rods...', description: 'Own every purchasable and craftable rod.', icon: 'üöÄ', reward: 'triversal' },
    ];
    // --- END ACHIEVEMENTS CONFIGURATION ---

    // --- State Variables ---
    let money = 0; 
    let currentRod = FISHING_RODS[0];
    const ownedRods = new Set(['basic']);
    const inventory = {};
    const fishIndex = new Set();
    let completedAchievements = new Set(); 
    let minigameActive = false;
    let minigameInterval;
    let currentFishRarity = null;
    
    // Level Variables
    let level = 1;
    let fishCaught = 0;
    let fishNeededForLevel = 50; 

    // --- DOM Elements ---
    const fishingButton = document.getElementById('fishing-button');
    const shopButton = document.getElementById('shop-button');
    const sellAllButton = document.getElementById('sell-all-button');
    const saveButton = document.getElementById('save-button');
    const resultDiv = document.getElementById('result');
    const fishList = document.getElementById('fish-list');
    const minigameOverlay = document.getElementById('minigame-overlay');
    const minigameButton = document.getElementById('minigame-button');
    const progressBar = document.getElementById('progress-bar');
    const targetArea = document.getElementById('target-area');
    const minigameFeedback = document.getElementById('minigame-feedback');
    const moneyDisplay = document.getElementById('money-display'); 
    const rodNameSpan = document.getElementById('rod-name'); 
    const rodLuckSpan = document.getElementById('rod-luck'); 
    const rodSpeedSpan = document.getElementById('rod-speed'); 
    const shopItemsList = document.getElementById('shop-items-list'); 
    const craftingRecipesList = document.getElementById('crafting-recipes-list');
    const indexList = document.getElementById('index-list');
    const currentLevelSpan = document.getElementById('current-level');
    const levelProgressBar = document.getElementById('level-progress-bar');
    const progressTextDiv = document.getElementById('progress-text');
    const achievementsListDiv = document.getElementById('achievements-list'); 

    // --- Minigame Variables ---
    let progress = 0;
    let barDirection = 1;
    const BASE_BAR_SPEED = 2.5; // FIXED speed for the progress bar movement
    const BASE_REEL_INCREMENT = 5;
    const CATCH_THRESHOLD = 100;

    // --- Utility Functions ---

    function getRarity(rarityName) {
        return RARITIES.find(r => r.name === rarityName);
    }
    
    function getFishCountInInventory(key) {
        return inventory[key] || 0;
    }

    function getRodById(id) {
        return FISHING_RODS.find(r => r.id === id);
    }

    // --- SAVE/LOAD FUNCTIONS ---

    function saveGame() {
        const gameState = {
            money: money,
            currentRodId: currentRod.id,
            ownedRods: Array.from(ownedRods),
            inventory: inventory,
            level: level,
            fishCaught: fishCaught,
            fishNeededForLevel: fishNeededForLevel,
            fishIndex: Array.from(fishIndex),
            completedAchievements: Array.from(completedAchievements) 
        };
        // Use JSON.stringify to convert the object to a string for storage
        localStorage.setItem('fishingGameSave', JSON.stringify(gameState));
        resultDiv.textContent = `üíæ Game Saved! (${new Date().toLocaleTimeString()})`;
    }

    function loadGame() {
        const savedData = localStorage.getItem('fishingGameSave');
        if (!savedData) {
            resultDiv.textContent = "No saved game found. Starting new game!";
            return;
        }

        // Use JSON.parse to convert the stored string back into an object
        const gameState = JSON.parse(savedData);

        // Load basic variables
        money = gameState.money;
        level = gameState.level;
        fishCaught = gameState.fishCaught;
        fishNeededForLevel = gameState.fishNeededForLevel;

        // Load complex variables
        Object.assign(inventory, gameState.inventory);
        gameState.ownedRods.forEach(id => ownedRods.add(id));
        gameState.fishIndex.forEach(key => fishIndex.add(key));
        if (gameState.completedAchievements) { 
            gameState.completedAchievements.forEach(id => completedAchievements.add(id));
        }

        // Manually add reward rods to ownedRods if the associated achievement is met
        if (completedAchievements.has('allRods') && !ownedRods.has('triversal')) {
             ownedRods.add('triversal');
        }

        // Load current rod, defaulting to Basic if the saved rod is somehow missing
        currentRod = getRodById(gameState.currentRodId) || FISHING_RODS[0];

        // Run checks after load to ensure data consistency and potential retro-active achievement grants
        checkAchievements();

        // Update all displays
        updateMoneyDisplay();
        updateRodDisplay();
        updateInventoryDisplay();
        updateFishIndexDisplay();
        updateLevelDisplay();
        updateAchievementsDisplay(); 
        resultDiv.textContent = "‚úÖ Game Loaded Successfully!";
    }

    // --- Level Functions ---

    function updateLevelDisplay() {
        currentLevelSpan.textContent = level;
        
        const progressPercent = (fishCaught / fishNeededForLevel) * 100;
        levelProgressBar.style.width = `${Math.min(100, progressPercent)}%`;
        
        progressTextDiv.textContent = `${fishCaught} / ${fishNeededForLevel} Fish Caught`;

        if (fishCaught >= fishNeededForLevel) {
            levelUp();
        }
        checkAchievements(); 
    }

    function levelUp() {
        level++;
        // Carry over any excess fish caught
        fishCaught = fishCaught - fishNeededForLevel; 
        fishNeededForLevel += 10; 

        resultDiv.textContent = `üéâ Leveled Up! You are now Level ${level}!`;
        updateLevelDisplay();
    }

    // --- Achievement Functions ---

    function checkAchievements() {
        let newAchievementUnlocked = false;

        ACHIEVEMENTS_LIST.forEach(ach => {
            if (completedAchievements.has(ach.id)) return;

            let requirementMet = false;

            switch (ach.type) {
                case 'money':
                    requirementMet = money >= ach.goal;
                    break;
                case 'level':
                    requirementMet = level >= ach.goal;
                    break;
                case 'fishCaught':
                    requirementMet = fishCaught >= ach.goal;
                    break;
                case 'rarity':
                    requirementMet = Array.from(fishIndex).some(key => key.startsWith(ach.goal + ':'));
                    break;
                case 'rod':
                    requirementMet = ownedRods.has(ach.goal);
                    break;
                case 'collection':
                    if (ach.id === 'rarityRampage') {
                        // Check if a fish from every rarity tier has been discovered
                        const discoveredRarities = new Set(Array.from(fishIndex).map(key => key.split(':')[0]));
                        requirementMet = ach.goal.every(rarityName => discoveredRarities.has(rarityName));
                    } else if (ach.id === 'allRods') {
                        // Check if every non-reward rod is owned
                        requirementMet = ach.goal.every(rodId => ownedRods.has(rodId));
                    }
                    break;
            }

            if (requirementMet) {
                completedAchievements.add(ach.id);
                resultDiv.innerHTML = `üèÜ **ACHIEVEMENT UNLOCKED!** ${ach.title} (${ach.description})`;
                newAchievementUnlocked = true;
                
                // Reward Logic for "Rods and Rods..."
                if (ach.id === 'allRods' && ach.reward) {
                    const rewardRod = getRodById(ach.reward);
                    if (rewardRod && !ownedRods.has(rewardRod.id)) {
                        ownedRods.add(rewardRod.id);
                        currentRod = rewardRod; // Instantly equip the ultimate rod
                        resultDiv.innerHTML += `<br>‚ú® **REWARD!** You unlocked and equipped the legendary **${rewardRod.name}**!`;
                        updateRodDisplay();
                        updateShopDisplay();
                        updateCraftingDisplay();
                    }
                }
            }
        });

        if (newAchievementUnlocked) {
            updateAchievementsDisplay();
            saveGame(); 
        }
    }

    function updateAchievementsDisplay() {
        achievementsListDiv.innerHTML = '';

        // Sort by completion status, then by ID (for stable ordering)
        const sortedAchievements = ACHIEVEMENTS_LIST.sort((a, b) => {
            const aCompleted = completedAchievements.has(a.id);
            const bCompleted = completedAchievements.has(b.id);
            
            if (aCompleted === bCompleted) {
                return a.id.localeCompare(b.id);
            }
            return aCompleted ? -1 : 1; // Completed ones come first
        });

        sortedAchievements.forEach(ach => {
            const isCompleted = completedAchievements.has(ach.id);
            const achDiv = document.createElement('div');
            achDiv.className = `achievement-item ${isCompleted ? 'completed' : ''}`;

            let statusText = isCompleted ? 'UNLOCKED' : 'LOCKED';
            let progressText = '';

            // Optional: Add progress text for incomplete achievements
            if (!isCompleted) {
                 switch (ach.type) {
                    case 'money':
                        progressText = `($${money.toLocaleString()}/$${ach.goal.toLocaleString()})`;
                        break;
                    case 'level':
                        progressText = `(Lvl ${level}/${ach.goal})`;
                        break;
                    case 'fishCaught':
                        progressText = `(${fishCaught}/${ach.goal})`;
                        break;
                    case 'rarity':
                        const found = Array.from(fishIndex).some(key => key.startsWith(ach.goal + ':'));
                        progressText = `(${found ? 'Found' : 'Missing'} ${ach.goal})`;
                        break;
                    case 'rod':
                        progressText = `(${ownedRods.has(ach.goal) ? 'Owned' : 'Missing'})`;
                        break;
                    case 'collection':
                        if (ach.id === 'rarityRampage') {
                            const discoveredCount = new Set(Array.from(fishIndex).map(key => key.split(':')[0])).size;
                            progressText = `(${discoveredCount}/${ach.goal.length} Rarities)`;
                        } else if (ach.id === 'allRods') {
                            const ownedCount = ach.goal.filter(rodId => ownedRods.has(rodId)).length;
                            progressText = `(${ownedCount}/${ach.goal.length} Rods)`;
                        }
                        break;
                }
            }

            achDiv.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <span class="achievement-icon">${isCompleted ? '‚úÖ' : ach.icon}</span>
                    <div>
                        <div class="achievement-title">${ach.title}</div>
                        <div class="achievement-desc">${ach.description}</div>
                    </div>
                </div>
                <div class="achievement-status">${statusText} ${progressText}</div>
            `;
            achievementsListDiv.appendChild(achDiv);
        });
    }

    // --- Core Game Functions ---
    
    function formatMoney(amount) {
        if (amount >= 1000000000000000) {
            return `$${(amount / 1000000000000000).toFixed(2)}Q`; // Quadrillion
        }
        if (amount >= 1000000000000) {
            return `$${(amount / 1000000000000).toFixed(2)}T`; // Trillion
        }
        if (amount >= 1000000000) {
            return `$${(amount / 1000000000).toFixed(2)}B`; // Billion
        }
        if (amount >= 1000000) {
            return `$${(amount / 1000000).toFixed(2)}M`; // Million
        }
        return `$${amount.toLocaleString()}`;
    }

    function updateMoneyDisplay() {
        moneyDisplay.textContent = `üí∞ Money: ${formatMoney(money)}`;
        updateShopDisplay();
        checkAchievements(); 
    }
    
    function updateRodDisplay() {
        rodNameSpan.textContent = currentRod.name;
        rodLuckSpan.textContent = currentRod.luck.toLocaleString();
        rodSpeedSpan.textContent = `${currentRod.lureSpeedMultiplier.toFixed(1)}x Reel Progress`; 
        checkAchievements(); 
    }

    function getFishRarity() {
        const modifiedRarities = RARITIES.map(r => {
            if (r.name === 'Common') {
                return { ...r, chance: Math.max(1, r.chance - currentRod.luck * 0.5) }; 
            } else if (r.name !== 'Uncommon') {
                // Apply luck boost to rarity chance. Higher luck means higher rarity chance.
                return { ...r, chance: r.chance + (currentRod.luck / 8) }; 
            }
            return r; 
        });

        const totalModifiedChance = modifiedRarities.reduce((sum, item) => sum + item.chance, 0);
        let random = Math.random() * totalModifiedChance;

        for (const item of modifiedRarities) {
            if (random < item.chance) {
                return getRarity(item.name); 
            }
            random -= item.chance;
        }
        return RARITIES[0];
    }

    function getFishName(rarityName) {
        const names = FISH_NAMES[rarityName];
        return names[Math.floor(Math.random() * names.length)];
    }

    function startFishing() {
        if (minigameActive) return;

        fishingButton.disabled = true;
        resultDiv.textContent = 'Reeling in...';
        currentFishRarity = getFishRarity();
        
        setTimeout(startMiniGame, 1500);
    }
    
    // --- MINI-GAME FUNCTIONS ---
    function startMiniGame() {
        minigameActive = true;
        minigameOverlay.style.display = 'flex';
        progressBar.style.width = '0%';
        progressBar.catchProgress = 0; // Initialize catch progress here
        progress = 50;
        barDirection = 1;
        minigameFeedback.textContent = 'Keep the bar in the red zone!';

        const targetSize = 20 + Math.random() * 10;
        const targetPos = 10 + Math.random() * (100 - targetSize - 10);
        targetArea.style.width = `${targetSize}%`;
        targetArea.style.left = `${targetPos}%`;
        targetArea.targetLeft = targetPos;
        targetArea.targetRight = targetPos + targetSize;
        
        minigameInterval = setInterval(updateMiniGame, 50);
    }

    function updateMiniGame() {
        // Bar movement logic - now uses FIXED speed regardless of rod
        const currentSpeed = BASE_BAR_SPEED; 
        progress += currentSpeed * barDirection;
        if (progress >= 100 || progress <= 0) {
            barDirection *= -1; 
            progress = Math.max(0, Math.min(100, progress));
        }
        progressBar.style.width = `${progress}%`;
    }

    function reelAction() {
        if (!minigameActive) return;

        const isTargeted = progress >= targetArea.targetLeft && progress <= targetArea.targetRight;
        // Progress gain is multiplied by the rod's lureSpeedMultiplier
        const progressGain = BASE_REEL_INCREMENT * currentRod.lureSpeedMultiplier;

        if (isTargeted) {
            progressBar.catchProgress += progressGain;
            minigameFeedback.textContent = `HIT! Catch Progress: ${progressBar.catchProgress.toFixed(0)}% (+${progressGain.toFixed(1)})`;
            
            if (progressBar.catchProgress >= CATCH_THRESHOLD) {
                endMiniGame(true);
            }
        } else {
            // Failure loss is still based on the base reel increment
            progressBar.catchProgress = Math.max(0, progressBar.catchProgress - BASE_REEL_INCREMENT * 2);
            minigameFeedback.textContent = `MISS! Catch Progress: ${progressBar.catchProgress.toFixed(0)}% (-${(BASE_REEL_INCREMENT * 2).toFixed(0)})`;
            if (progressBar.catchProgress <= 0) {
                endMiniGame(false); // Fail if progress drops too low
            }
        }
    }
    
    function endMiniGame(success) {
        clearInterval(minigameInterval);
        minigameActive = false;
        minigameOverlay.style.display = 'none';
        fishingButton.disabled = false;
        delete progressBar.catchProgress;

        if (success) {
            const fishName = getFishName(currentFishRarity.name);
            const message = `You successfully caught a <span class="${currentFishRarity.colorClass}">${currentFishRarity.name} ${fishName}!</span>`;
            resultDiv.innerHTML = message;
            
            addToInventory(currentFishRarity.name, fishName);
            
            fishCaught++;
            updateLevelDisplay();
        } else {
            resultDiv.textContent = 'The fish got away! Try again.';
        }
    }
    // --- END MINI-GAME FUNCTIONS ---


    function addToInventory(rarity, name) {
        const key = `${rarity}:${name}`;
        const wasNewDiscovery = !fishIndex.has(key);

        inventory[key] = (inventory[key] || 0) + 1;
        fishIndex.add(key); 

        if (wasNewDiscovery) {
            checkAchievements(); 
        }
        updateInventoryDisplay();
        updateFishIndexDisplay();
    }

    function updateInventoryDisplay() {
        fishList.innerHTML = '';
        const rarityOrder = RARITIES.map(r => r.name);
        
        const sortedKeys = Object.keys(inventory).sort((a, b) => {
            const rarityA = a.split(':')[0];
            const rarityB = b.split(':')[0];
            // Sort from rarest (highest index) to least rare (lowest index)
            return rarityOrder.indexOf(rarityB) - rarityOrder.indexOf(rarityA);
        });

        for (const key of sortedKeys) {
            const [rarity, name] = key.split(':');
            const count = inventory[key];
            const rarityItem = getRarity(rarity);
            const colorClass = rarityItem ? rarityItem.colorClass : '';
            const value = rarityItem ? rarityItem.value : 0;

            const li = document.createElement('li');
            li.innerHTML = `<span class="${colorClass}">${rarity} ${name}</span> x${count} **(${formatMoney(value)}/ea)**`;
            fishList.appendChild(li);
        }
        
        sellAllButton.disabled = Object.keys(inventory).length === 0;
    }
    
    function updateFishIndexDisplay() {
        indexList.innerHTML = '';
        // Sort from RAREST to LEAST RARE (reverse of the RARITIES array order)
        const rarityOrder = [...RARITIES].map(r => r.name).reverse(); 
        
        const discoveredFishByRarity = {};
        fishIndex.forEach(key => {
            const [rarity, name] = key.split(':');
            if (!discoveredFishByRarity[rarity]) {
                discoveredFishByRarity[rarity] = [];
            }
            discoveredFishByRarity[rarity].push(name);
        });

        rarityOrder.forEach(rarityName => {
            const fishNames = discoveredFishByRarity[rarityName];
            if (fishNames && fishNames.length > 0) {
                const rarityItem = getRarity(rarityName);
                const colorClass = rarityItem.colorClass;

                const rarityGroupLi = document.createElement('li');
                rarityGroupLi.innerHTML = `<strong><span class="${colorClass}">${rarityName} Fish</span></strong>:`;
                
                fishNames.sort();
                
                const namesSpan = document.createElement('span');
                namesSpan.textContent = ` ${fishNames.join(', ')}`;
                rarityGroupLi.appendChild(namesSpan);

                indexList.appendChild(rarityGroupLi);
            }
        });
    }

    function sellAllFish() {
        if (Object.keys(inventory).length === 0) {
            resultDiv.textContent = "Your inventory is empty!";
            return;
        }

        let totalValue = 0;
        let fishSold = 0;

        for (const key in inventory) {
            const [rarity] = key.split(':');
            const count = inventory[key];
            const rarityItem = getRarity(rarity);
            const value = rarityItem ? rarityItem.value : 0;

            totalValue += count * value;
            fishSold += count;
            delete inventory[key];
        }

        money += totalValue;
        
        resultDiv.textContent = `üí∞ Sold ${fishSold} fish for ${formatMoney(totalValue)}!`;
        updateInventoryDisplay();
        updateMoneyDisplay();
    }
    
    // --- Shop Functions ---
    
    function openShop() {
        document.getElementById('shop-overlay').style.display = 'flex';
        updateShopDisplay();
        updateCraftingDisplay();
    }
    
    function closeShop() {
        document.getElementById('shop-overlay').style.display = 'none';
    }
    
    function updateShopDisplay() {
        shopItemsList.innerHTML = '';
        
        // Filter for purchase rods (those with a 'cost' property)
        FISHING_RODS.filter(rod => rod.cost !== undefined).forEach(rod => {
            const isOwned = ownedRods.has(rod.id);
            const isEquipped = currentRod.id === rod.id;
            const canAfford = money >= rod.cost;
            
            const rodDiv = document.createElement('div');
            rodDiv.className = 'rod-item';
            
            let buttonHTML;
            if (isEquipped) {
                buttonHTML = `<span class="equipped-label">EQUIPPED</span>`;
            } else if (isOwned) {
                buttonHTML = `<button class="buy-button" onclick="equipRod('${rod.id}')">Equip</button>`;
            } else {
                buttonHTML = `<button class="buy-button" ${!canAfford ? 'disabled' : ''} onclick="buyRod('${rod.id}', ${rod.cost})">Buy (${formatMoney(rod.cost)})</button>`;
            }
            
            rodDiv.innerHTML = `
                <div>
                    <strong>${rod.name}</strong> 
                    <div class="rod-stats">
                        <span>LUCK: +${rod.luck.toLocaleString()}</span>
                        <span>REEL SPEED: x${rod.lureSpeedMultiplier.toFixed(1)}</span>
                    </div>
                </div>
                ${buttonHTML}
            `;
            
            shopItemsList.appendChild(rodDiv);
        });
    }
    
    function updateCraftingDisplay() {
        craftingRecipesList.innerHTML = '';
        
        // Filter for craftable rods (those with a 'recipe' property) or reward rods
        FISHING_RODS.filter(rod => rod.recipe !== undefined || rod.isReward).forEach(rod => {
            const isOwned = ownedRods.has(rod.id);
            const isEquipped = currentRod.id === rod.id;
            
            let buttonHTML;
            let materialsHtml = '';
            
            if (rod.isReward) {
                 // Special handling for reward rods
                if (isEquipped) {
                    buttonHTML = `<span class="equipped-label">EQUIPPED</span>`;
                } else if (isOwned) {
                    buttonHTML = `<button class="buy-button" onclick="equipRod('${rod.id}')">Equip</button>`;
                } else {
                    buttonHTML = `<span style="color:red; font-size:0.8em;">Unlock via Achievement!</span>`;
                }
                materialsHtml = 'Achieved by **Rods and Rods...** achievement.';

            } else {
                // Normal crafting logic
                let canCraft = true;
                
                rod.recipe.forEach(material => {
                    const requiredKey = `${material.rarity}:${material.name}`;
                    const ownedCount = getFishCountInInventory(requiredKey);
                    const hasRequired = ownedCount >= material.required;
                    
                    if (!hasRequired) {
                        canCraft = false;
                    }
                    
                    const rarityItem = getRarity(material.rarity);
                    const colorClass = rarityItem ? rarityItem.colorClass : '';
                    
                    materialsHtml += `<span style="color: ${hasRequired ? '#008000' : '#dc3545'}">
                                        <span class="${colorClass}">${material.name}</span> (${ownedCount}/${material.required})
                                      </span>`;
                });
                
                if (isEquipped) {
                    buttonHTML = `<span class="equipped-label">EQUIPPED</span>`;
                } else if (isOwned) {
                    buttonHTML = `<button class="buy-button" onclick="equipRod('${rod.id}')">Equip</button>`;
                } else {
                    buttonHTML = `<button class="craft-button" ${!canCraft ? 'disabled' : ''} onclick="craftRod('${rod.id}')">CRAFT</button>`;
                }
            }


            const rodDiv = document.createElement('div');
            rodDiv.className = 'rod-item craft-recipe';

            rodDiv.innerHTML = `
                <div>
                    <strong>${rod.name}</strong> 
                    <div class="rod-stats">
                        <span>LUCK: +${rod.luck.toLocaleString()}</span>
                        <span>REEL SPEED: x${rod.lureSpeedMultiplier.toFixed(1)}</span>
                    </div>
                    <div class="recipe-materials">
                        Requires: ${materialsHtml}
                    </div>
                </div>
                ${buttonHTML}
            `;
            
            craftingRecipesList.appendChild(rodDiv);
        });
    }
    
    function buyRod(rodId, cost) {
        const rod = getRodById(rodId);
        
        if (money >= cost) {
            money -= cost;
            ownedRods.add(rodId);
            currentRod = rod;
            
            resultDiv.textContent = `You bought the ${rod.name} and equipped it!`;
            
            updateMoneyDisplay();
            updateRodDisplay();
            updateShopDisplay();
            updateCraftingDisplay();
            checkAchievements(); 
            saveGame(); 
        } else {
            alert("Not enough money to buy this rod!");
        }
    }
    
    function craftRod(rodId) {
        const rod = getRodById(rodId);
        if (!rod || !rod.recipe) return;

        let canCraft = true;
        
        const itemsToRemove = [];
        rod.recipe.forEach(material => {
            const requiredKey = `${material.rarity}:${material.name}`;
            if (getFishCountInInventory(requiredKey) < material.required) {
                canCraft = false;
            }
            itemsToRemove.push({ key: requiredKey, count: material.required });
        });

        if (canCraft) {
            itemsToRemove.forEach(item => {
                inventory[item.key] -= item.count;
                if (inventory[item.key] <= 0) {
                    delete inventory[item.key];
                    fishIndex.delete(item.key);
                }
            });
            
            ownedRods.add(rodId);
            currentRod = rod;
            
            resultDiv.textContent = `üî® Crafted the ${rod.name} and equipped it!`;

            updateInventoryDisplay();
            updateFishIndexDisplay();
            updateRodDisplay();
            updateCraftingDisplay();
            checkAchievements(); 
            saveGame(); 
        } else {
            alert("You are missing materials to craft this rod!");
        }
    }
    
    function equipRod(rodId) {
        const rod = getRodById(rodId);
        if (ownedRods.has(rodId)) {
            currentRod = rod;
            updateRodDisplay();
            updateShopDisplay();
            updateCraftingDisplay();
            checkAchievements(); 
            resultDiv.textContent = `üé£ Equipped the ${rod.name}.`;
            saveGame(); 
        }
    }
    

    // --- Event Listeners and Initial Setup ---
    fishingButton.addEventListener('click', startFishing);
    minigameButton.addEventListener('click', reelAction);
    sellAllButton.addEventListener('click', () => { sellAllFish(); saveGame(); }); 
    shopButton.addEventListener('click', openShop);
    saveButton.addEventListener('click', saveGame); 

    // Make the custom functions globally accessible (useful for inline HTML events)
    window.openShop = openShop;
    window.closeShop = closeShop;
    window.buyRod = buyRod;
    window.craftRod = craftRod;
    window.equipRod = equipRod;
    window.formatMoney = formatMoney; // Expose for use in display functions if needed

    // 1. Attempt to load the game state
    loadGame(); 
    
    // 2. Set up the Autosave timer (saves every 30 seconds)
    setInterval(saveGame, 30000);
    
    // 3. Ensure all displays are updated based on the loaded (or initial) state
    updateMoneyDisplay();
    updateRodDisplay();
    updateInventoryDisplay();
    updateFishIndexDisplay();
    updateLevelDisplay();
    updateAchievementsDisplay(); 
</script>

</body>
</html>